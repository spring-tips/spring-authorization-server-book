<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="author" content="Josh Long">
<title>Authorize All the Things with the Spring Authorization Server, OAuth, and Spring Boot</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article">
<div id="header">
<h1>Authorize All the Things with the Spring Authorization Server, OAuth, and Spring Boot</h1>
<div class="details">
<span id="author" class="author">Josh Long</span><br>
<span id="email" class="email"><a href="mailto:josh@joshlong.com">josh@joshlong.com</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introducing_the_spring_authorization_server">Introducing the Spring Authorization Server</a></li>
<li><a href="#_the_journey_ahead">The Journey Ahead</a></li>
<li><a href="#_try_it_out">Try it out!</a></li>
<li><a href="#_docker_compose_and_our_middleware">Docker Compose and our Middleware</a></li>
<li><a href="#_stand_up_a_spring_authorization_server_instance_for_great_good">Stand up a Spring Authorization Server Instance for Great Good</a>
<ul class="sectlevel2">
<li><a href="#_users">Users</a></li>
<li><a href="#_oauth_clients">OAuth Clients</a></li>
<li><a href="#_persistence_with_postgresql_and_jdbc">Persistence with PostgreSQL and JDBC</a></li>
</ul>
</li>
<li><a href="#_protecting_a_simple_http_api">Protecting a Simple HTTP API</a></li>
<li><a href="#_the_gateway_client">The Gateway Client</a></li>
<li><a href="#_your_first_cup_of_java">Your First Cup of Java</a>
<ul class="sectlevel2">
<li><a href="#_operations_improvements">Operations Improvements</a></li>
<li><a href="#_performance">Performance</a></li>
<li><a href="#_autocloseable">Autocloseable</a></li>
<li><a href="#_type_inference">Type Inference</a></li>
<li><a href="#_enhanced_switch_expressions">Enhanced Switch Expressions</a></li>
<li><a href="#_multiline_strings">Multiline Strings</a></li>
<li><a href="#_records">Records</a></li>
<li><a href="#_sealed_types">Sealed Types</a></li>
<li><a href="#_smart_casts">Smart Casts</a></li>
<li><a href="#_function_interfaces_lambdas_and_method_references">Function Interfaces, Lambdas  and Method References</a></li>
<li><a href="#_virtual_threads_and_loom">Virtual Threads and Loom</a></li>
<li><a href="#_next_steps">Next Steps</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Josh Long loves the Spring Authorization Server, and want you to love it too.
Let&#8217;s dive right into it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introducing_the_spring_authorization_server">Introducing the Spring Authorization Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hi, Spring fans!
In this installment we&#8217;re going to look at some patterns and practices for working with the Spring Authorization Server, and with OAuth in general in a Spring Boot-based system.</p>
</div>
<div class="paragraph">
<p>The Spring Authorization Server is one of my favorite new projects.
It&#8217;s a full-blown OAuth identity provider (IDP), distributed as Spring Boot autoconfiguration.</p>
</div>
<div class="paragraph">
<p>The Spring Authorization Server is the final piece in the Spring Security OAuth&#8217;s Ship of Theseus, the final replacement for a component in the built-in OAuth support in Spring Security 5 and later.
First there was OIDC client support, and then resource server support, and now - after a <em>lot</em> of community outpouring and support - a brand new and fully featured OAuth IDP.</p>
</div>
<div class="paragraph">
<p>Why not use Keycloak, Okta, Auth0, ActiveDirectory, or something, I hear you ask?
And the answer is.. be our guest! 99% of the stuff we&#8217;re going to look at here works with any OAuth IDP.
But i do so love the Spring Authorization Server.
I don&#8217;t know an easier way to get as configurable and flexible IDP up-and-running.</p>
</div>
<div class="paragraph">
<p>Having an easy component for your IDP integration is <em>liberating</em>.
If nothing else, it&#8217;s one less <code>users</code> microservice for you to build.
But, at its best, it&#8217;s a unifying force for your organization&#8217;s notions of identity and policy, all centralized.
If you implement it correctly, it&#8217;s one less <code>users</code> microservice for <em>all</em> of your systems, not just the one you&#8217;re working on now!</p>
</div>
<div class="paragraph">
<p>It&#8217;s Spring, so it of course supports the new-and-novel, but it&#8217;s also built like all Spring Boot autoconfiguration, with hooks and customization in mind at every step.</p>
</div>
<div class="paragraph">
<p>I love it and I love it for helping me to love OAuth.
If you only knew the agony I&#8217;ve been subjected to in learning and welding OAuth over the years, then you&#8217;ll know what a thing that is for me to say.
And I want you, dear reader, to love OAuth.
And the way to do that is to, basically, <em>not</em> care about OAuth.</p>
</div>
<div class="paragraph">
<p>And so we&#8217;re going to take a journey to production together, with the Spring Authorization Server at our backs, and learn how to wield OAuth (via the amazing Spring Authorization Server) for some common kinds of patterns.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_journey_ahead">The Journey Ahead</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to do a breadth-first not depth-first approach to using the Spring Authorization Server, so we&#8217;re going to look at several pieces.
By the end of this, we&#8217;ll have explored:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a Spring Authorization Server instance (called <code>authorization-server</code>)</p>
</li>
<li>
<p>a backend HTTP API protected by Spring Security&#8217;s OAuth 2 Resource Server capability (called <code>api</code>)</p>
</li>
<li>
<p>a headless RabbitMQ-powered microservice whose request handling is done with Spring Integration, and protected by Spring Security&#8217;s OAuth 2 Resource Server capability, <em>sort of</em>. (called <code>processor</code>)</p>
</li>
<li>
<p>a static JavaScript application.
I hesitate to even call it an application.
It&#8217;s one page, <code>index.html</code> (called <code>static</code>)</p>
</li>
<li>
<p>a Spring Cloud Gateway instance that&#8217;s acting as an OAuth 2 token relay and OAuth 2 client, originating new OAuth 2 tokens if they&#8217;re not present and then forwarding requests onward to the backend HTTP API and static JavaScript assets with the token in tow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll start first with the main event, the Spring Authorization Server.
Arguably, everything <em>after</em> that section would work equally well with any other OAuth 2 identity provider (IDP).
But maybe you&#8217;ll see in reading this section that you don&#8217;t <em>need</em> any other OAuth 2 identity provider any more.
Either way, read on!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_try_it_out">Try it out!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, before we get ahead of ourselves, let&#8217;s try it out!
Grab (<code>git clone</code>) the <a href="https://github.com/spring-tips/spring-authorization-server">code here</a> to follow along.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in the root folder of the code, run <code>docker compose up</code></p>
</li>
<li>
<p>in <code>authorization-service</code>, run <code>run.sh</code></p>
</li>
<li>
<p>in <code>gateway</code>, run <code>run.sh</code></p>
</li>
<li>
<p>in <code>api</code>, run <code>run.sh</code></p>
</li>
<li>
<p>in <code>processor</code>, run <code>run.sh</code></p>
</li>
<li>
<p>in <code>static</code>, run <code>run.sh</code></p>
</li>
<li>
<p>visit <code><a href="http://127.0.0.1:8082" class="bare">http://127.0.0.1:8082</a></code> (important: use the IP, <em>not</em> <code>localhost</code>!) in the browser.</p>
</li>
<li>
<p>login with <code>jlong</code>/<code>password</code> (yes, I know it&#8217;s a terrible password, don&#8217;t <code>@</code> me!), and then consent when prompted.</p>
</li>
<li>
<p>you&#8217;ll see a list of customers, click on the <code>email</code> button to kick off work in the <code>processor</code>.
You should see indications in the console that your message has been sent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are lots of moving parts, but here&#8217;s what you need to know: we have a JavaScript/HTML 5 client, a backend HTTP API, and a headless backoffice process, all of which have been secured with the Spring Authorization Server.</p>
</div>
<div class="paragraph">
<p>Shut everything down, and we&#8217;ll start from scratch.</p>
</div>
<div class="paragraph">
<p>Refreshingly simple.
Let&#8217;s dive right into the nitty-gritty.
I want you building secure systems by the article&#8217;s end.
My goal here is not to cover <em>every</em> possible use case, but to cover some of the typical use-cases and introduce progressively more moving parts so that, if at some point you don&#8217;t see what you need, you know where to reach you to build it yourself.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_compose_and_our_middleware">Docker Compose and our Middleware</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I know I just told you to shut everything down, but you need to restart one thing: the Docker images for both PostgreSQL and RabbitMQ.
I&#8217;ve described all of their configuration in a <code>docker-compose.yml</code> file in the root of this project.
It looks like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">postgres</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:15.2</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_USER=postgres</span>
      <span class="pi">-</span> <span class="s">PGUSER=postgres</span>
      <span class="pi">-</span> <span class="s">POSTGRES_NAME=postgres</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD=postgres</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">5432:5432"</span>
  <span class="na">rabbitmq</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rabbitmq:3-management</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_USER=user</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_PASS=password</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">5672:5672"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">15672:15672"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll be connecting to either or both of the Docker images across many different services, so let&#8217;s start them up before we proceed.</p>
</div>
<div class="paragraph">
<p>Go to the root of the project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">docker compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>RabbitMQ will be running on the usual port and have a user, <code>user</code>, and a password, <code>password</code>.
PostgresSQL will be running on the usual port with the user <code>postgres</code>, schema called <code>postgres</code>, and the password <code>postgres</code>.
Yes, I know these are terrible passwords&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stand_up_a_spring_authorization_server_instance_for_great_good">Stand up a Spring Authorization Server Instance for Great Good</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Go to the <a href="https://start.spring.io">Spring Initializr (start.spring.io)</a>, specify a group ID and an artifact ID (I chose <code>bootiful</code> : <code>authorization-server</code>) and add  <code>OAuth2 Authorization Server</code> as a dependency.
I&#8217;d add <code>GraalVM Native Support</code> for good measure, but you do you.
Open the downloaded project in your IDE.
I&#8217;m using IntelliJ IDEA, but again, you do you.
I ran the following command from the root of the newly unzipped archive: <code>idea build.gradle</code>.</p>
</div>
<div class="paragraph">
<p>You&#8217;ve got a new Spring Boot Authorization Server.
We need to specify two things: <strong>users</strong>, and <strong>clients</strong>.</p>
</div>
<div class="sect2">
<h3 id="_users">Users</h3>
<div class="paragraph">
<p>Users are pretty straight forward, right?
A user is the sum of the username, password, and associated information attached to the systems' notion of identity.
The beating heart of our system.</p>
</div>
<div class="paragraph">
<p>There are a lot of ways to get this done.
The easiest might be to just have one user, the <em>default</em> user, which you can describe using Spring Boot&#8217;s associated properties, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">spring.security.user.name</span><span class="p">=</span><span class="s">jlong</span>
<span class="py">spring.security.user.password</span><span class="p">=</span><span class="s">password</span>
<span class="py">spring.security.user.roles</span><span class="p">=</span><span class="s">admin,users.write,users.read,openid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gets us off the ground, but as soon as you want two or more users, you&#8217;ll need to specify them a different way.
The easiest is probably to define a bean of type   <code>InMemoryUserDetailsManager</code>, like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>package bootiful.authorizationserver;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;

@Configuration
class UserDetailsConfiguration {

    @Bean
    UserDetailsService inMemoryUserDetailsManager() {
        var userBuilder = User.withDefaultPasswordEncoder();
        return new InMemoryUserDetailsManager(
                userBuilder.roles("USER").username("jlong").password("password").build(),
                userBuilder.roles("USER", "ADMIN").username("rwinch").password("p@ssw0rd").build()
        );
    }

}</pre>
</div>
</div>
<div class="paragraph">
<p>Thus configured we&#8217;ve got two users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jlong</code> with password <code>password</code> and roles <code>USER</code></p>
</li>
<li>
<p><code>rwinch</code> with password <code>p@ssw0rd</code> and roles <code>USER</code> and <code>ADMIN</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This implementation is fine for development as it&#8217;s all in-memory.
In a production system, you&#8217;ll probably want something more durable.
We&#8217;ll look at those possibilities in a bit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_oauth_clients">OAuth Clients</h3>
<div class="paragraph">
<p>An OAuth client defines how a program or process interacts with an OAuth IDP (like Spring Authorization Server).
Clients correspond more or less to the programs that would like to be allowed to authenticate on behalf of users.</p>
</div>
<div class="paragraph">
<p>I have tried to conceive of a clear illustration of clients in a vacuum, but it&#8217;s not easy. so let&#8217;s examine a real life example: you stumble upon some website, say <a href="https://www.yelp.com/">Yelp</a>, a website that lets you contribute and read reviews about locations - restaurants, businesses, tourist spots, etc.
You want to login to see your history.
You <em>could</em> create a new account there, going through the whole sign up flow and entering redundant information, but this information could soon become stale.
Maybe you change house or email address, or whatever, and you&#8217;ve forgotten to go back to the site and change your information.
Yelp know this, so they offer another path forward: <code>Continue with Google</code> and <code>Continue with Apple</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/yelp-signup.png" alt="yelp signup">
</div>
</div>
<div class="paragraph">
<p>Click the button and another window on Google or Apple&#8217;s sites pop up.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/google-signin.png" alt="google signin">
</div>
</div>
<div class="paragraph">
<p>You know what to do here: you&#8217;re in familiar territory.
It&#8217;s google.com!
You know Google.
And Google <em>definitely</em>  knows you!
You&#8217;ve got an account here, you maintain that account, and you like that account.
You use it for your daily email, after all.
You&#8217;ve even got that reassuring little padlock icon in the browser&#8217;s location bar giving you the warm-n-fuzzies about this site&#8217;s authenticity: it is who it claims to be.
So you enter your information, login, and you have to whatever mutli-factor auth things Google wants you to do.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/google-mfa.png" alt="google mfa">
</div>
</div>
<div class="paragraph">
<p>This shows up as a prompt on a completely different device, an iPad.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/google-is-it-you.png" alt="google is it you">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ve approved of the login, so that Google knows it really is you logging in, and now it&#8217;s got to make sure you realize you&#8217;re handing over some of the data associated with your identity to this new website, Yelp.com, so it throws up a consent form.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/google-consent-screen.png" alt="google consent screen">
</div>
</div>
<div class="paragraph">
<p>You click <code>Confirm</code> and then are finally logged in, with your Google identity, on Yelp.com</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/yelp-logged-in-with-google-part-2.png" alt="yelp logged in with google part 2">
</div>
</div>
<div class="paragraph">
<p>At the end of this dance, Google.com transmitted a <em>token</em> to the application running at Yelp.com.
Armed with this, the application running at Yelp.com can now transmit requests to the Google.com APIs, asking it questions about you, like your email.
It might also be able to read your Google calendar events, location data, etc.
What precisely the application at Yelp.com has access to is a function of the <em>scopes</em> requested by the client.
The application at Yelp.com stores the token and uses it to interact with Google on your behalf.
Occasionally, Google.com will expire the token.
Tokens, like milk, go stale!
No worries: the application at Yelp.com has a <em>refresh</em> token it can use to refresh the token and get a new one.</p>
</div>
<div class="paragraph">
<p>You&#8217;re glad you signed up at Yelp.com, but look at the time!
It&#8217;s noon, the sun&#8217;s out and the kid wants to go play mini golf at the place you just found on Yelp.com.
Gotta go!</p>
</div>
<div class="paragraph">
<p>Time passes, and you return to Yelp.com a week later.
By this point, Yelp.com&#8217;s expired your HTTP session, and you&#8217;re logged out.
No problem.
Click the <code>Continue with Google</code> button again, and this time you&#8217;ll just be dumped into Yelp.com, fully authenticated.
Both Google and Yelp remember who you are and so there&#8217;s no ceremony this time.
You got fast-path&#8217;d into an authenticated HTTP session on Yelp.com.
Thus: OAuth is invaluable both for establishing a new account and for subsequently logging into it.
You may have changed your home address on Google.com in the meantime, and now Yelp.com can see the new address information and offer you updated recommendations, too.
So Yelp.com is kept up-to-date and all you had to do was keep Google.com up-to-date.</p>
</div>
<div class="paragraph">
<p>From the perspective of Google, Yelp.com is an OAuth client.
All the particulars of how you went through that authentication flow - whether you needed to be redirected to Google.com, whether you should be shown a consent form, and what data Yelp.com was allowed to read from the Google.com API once it had a token stemming from this authentication flow, was governed by how the developers at Yelp.com registered their client with Google.</p>
</div>
<div class="paragraph">
<p>Clients must stipulate a client ID, and a client secret.
The client Id and client secret are transmitted in the request initiating the authentication flow, signalling to Google that Yelp.com is making this request.
Clients also stipulate what <em>scopes</em> they want.
A scope is OAuth&#8217;s version of rights, permissions, authorities, or claims.
They&#8217;re (basically) arbitrary strings that mean something to Google.com&#8217;s API.</p>
</div>
<div class="paragraph">
<p>There is one scope, <code>openid</code>, which is part of the OIDC specification.
This scope means that you want to log in as a user with the OAuth flow.
This is a sort of special case; Yelp.com may not want to read Google Calendar data, or read your email.
Those scopes would necessarily be unique to Google&#8217;s APIs.
But signing a user into a site is a common enough thing and one that can be implemented usefully across all sorts of OAuth providers, so there&#8217;s a specification called OpenID Connect (OIDC), that builds on top of OAuth 2.0, prescribing standard scopes and , importantly, standard APIs by which a client may look up information associated with a user.
Yelp.com might only just need enough information from Google.com to fill out a signup form for us: name, email, etc.
In that case, it would just specify <code>openid</code> as a scope and call it good.
In this way the Yelp.com client could even reuse the same code across other OIDC compliant providers, changing only the client ID and client secret and the issuer URI (the API&#8217;s root URL).
Neat-o!</p>
</div>
<div class="paragraph">
<p>So, if you built a backoffice process, you&#8217;d register a client for that backoffice process.
If you built a new web application that you intend to support automatic sign-in with OAuth, you&#8217;d register a new client for that web application.</p>
</div>
<div class="paragraph">
<p>The simplest way to register clients in the Spring Authorization Server is to use properties in the <code>application.properties</code> or <code>application.yaml</code> file, like in this <code>application.yaml</code> example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">spring</span><span class="pi">:</span>
  <span class="na">security</span><span class="pi">:</span>
    <span class="na">oauth2</span><span class="pi">:</span>
      <span class="na">authorizationserver</span><span class="pi">:</span>
        <span class="na">client</span><span class="pi">:</span>
          <span class="na">crm-client</span><span class="pi">:</span>
            <span class="na">require-authorization-consent</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">registration</span><span class="pi">:</span>
              <span class="na">client-id</span><span class="pi">:</span> <span class="s">crm</span>
              # <b class="conum">(1)</b>
              <span class="na">client-secret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{bcrypt}$2a$10$m7dGi0viwVH63EjwZc6UdeUQxPuiVEEdFbZFI9nMxHAASTOIDlaVO"</span>
              # <b class="conum">(2)</b>
              <span class="na">authorization-grant-types</span><span class="pi">:</span> <span class="s">client_credentials, authorization_code, refresh_token</span>
              # <b class="conum">(3)</b>
              <span class="na">redirect-uris</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8082/login/oauth2/code/spring</span>
              # <b class="conum">(4)</b>
              <span class="na">scopes</span><span class="pi">:</span> <span class="s">user.read,user.write,openid</span>
              # <b class="conum">(5)</b>
              <span class="na">client-authentication-methods</span><span class="pi">:</span> <span class="s">client_secret_basic</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>you can use the <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/cli.html"><code>spring</code></a> CLI to encode a password for the client secret: <code>spring encodepassword BLAH</code>, where <code>BLAH</code> is the string you want to encode.
In our case, the client ID is <code>crm</code> and the client secret is <code>crm</code>.
(Again, I <em>know</em> it&#8217;s a terrible password.
Don&#8217;t <code>@</code> me!).
NB: For complex strings like this, YAML parsing rules can be problematic, so I tend to wrap these things in quotation marks.</p>
</li>
<li>
<p><code>authorization-grant-types</code> refers to the use case - web application, mobile, headless backoffice application, etc. - for the authentication flow. <a href="https://oauth.net/2/grant-types/">OAuth 2.0 is nothing if not flexible</a>.</p>
</li>
<li>
<p>we&#8217;re building a web application so the expectation is that, once you&#8217;ve authenticated yourself with the Spring Authorization Server, it&#8217;ll redirect you back to the web application with the token in tow.
But where?
You specify that here.
We haven&#8217;t looked at the application yet, so this is a bit of foreshadowing, but the redirect URI specified here is designed to line up with Spring Security&#8217;s OAuth client support, which we&#8217;ll use on the web application.</p>
</li>
<li>
<p>Here we specify which scopes we&#8217;d like to be given.
We&#8217;ve seen <code>openid</code> before, and the other two are arbitrary, and just for demonstration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>At this point, we have a valid Spring Authorization Server, and you&#8217;re ready to start using it!
Run the application in the usual way: <code>./gradlew bootRun</code> or <code>./mvnw spring-boot:run</code> or just run the main method from your IDE.
Congratulations on your first deployment of the Spring Authorization Server.
We <em>could</em> stop here, satisfied that we have got <em>something</em> to allow us to handle development chores and start building services.
Indeed, if you want to, you can skip ahead and things should work fine.</p>
</div>
<div class="paragraph">
<p>Eventually, however, you&#8217;re going to realize you can&#8217;t leave things as they are - you&#8217;ll need durable state.
As-is, everything is kept in-memory.
It&#8217;s obviously non-starter to need to deploy a new Spring Authorization Server every time you add a new client, user, or otherwise.
People will want self-service forms by which they can register new users, clients, etc.
All existing OAuth tokens would become invalid once you restart the Spring Authorization Server, too!
Indeed, all state related to any successful OAuth authorizations would be forgotten on every restart.
The situation&#8217;s not good, and in the next section, we&#8217;re going to look at introducing persistence, with JDBC, to get around it.</p>
</div>
<div class="paragraph">
<p>If you want to carry on using property files, then perhaps consider the Spring Cloud Config Server.
It&#8217;s another piece of Spring Boot-powered middleware that, once stood up, mediates access to configuration files via an HTTP API.
The configuration files live in a version control system, like Git, which the Spring Cloud Config Server monitors.
When the files change, the Spring Cloud Config Server serves up the new configuration data.
Even better, the Spring Cloud Config Server can, via the Spring Cloud Bus abstraction, publish notifications to your microservices (like the Spring Authorization Server) on an event bus like RabbitMQ or Apache Kafka so that you can automatically reload the new configuration.
This works particularly well in tandem with the Spring Cloud&#8217;s <code>@RefreshScope</code>.
In such a configuration, the configuration for everything still lives in a <code>.properties</code> or <code>.yaml</code> file, as it does now, but the files are centralized and can be changed without reloading the Spring Authorization Server.
Storing files in a version control system gives us niceties like versioning, auditing, rollbacks, etc., for very sensitive configuration data.
And, going a step further, you can even use the Spring Authorization Server to store data encrypted at rest.
For more on these possibilities, check out this <a href="https://www.youtube.com/watch?v=aC_siBP8rx8&amp;list=PLgGXSWYM2FpPw8rV0tZoMiJYSCiLhPnOc&amp;index=31">video I did some years ago</a>.
And <em>all</em> of these possibilities are enabled entirely because the Spring Authorization Server is delivered as just another Spring Boot autoconfiguration!</p>
</div>
</div>
<div class="sect2">
<h3 id="_persistence_with_postgresql_and_jdbc">Persistence with PostgreSQL and JDBC</h3>
<div class="paragraph">
<p>Spring makes it easy to substitute implementations with polymorphism.  <em>Dependency injection</em> is one of the key reasons we use Spring.
Spring Boot-based configuration makes this doubly powerful.
While the Spring Authorization Server does amazing things out of the box, its real power lay in all the knobs and leavers available to you because it&#8217;s just another Spring Boot autoconfiguration.
We have already acknowledged that keys parts of the Spring Authorization Server defer to in-memory implementations.
In this section, we&#8217;ll swap those, and more, out for implementations using JDBC.
We&#8217;ll use JDBC, but these are just interfaces.
If you don&#8217;t want to use JDBC, then feel free to implement the interfaces for yourself, deferring to whatever underlying storage mechanism you want.
Spring Data is your friend&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Before we can get started, we&#8217;ll need a PostgreSQL database.
Some place in which to store our state.
In the root of the project, run <code>docker compose up</code>.</p>
</div>
<div class="paragraph">
<p>Now, we&#8217;re going to need to retool our project to accomodate JDBC, so add the following dependencies to the Gradle build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">	<span class="n">runtimeOnly</span> <span class="s1">'org.postgresql:postgresql'</span>
	<span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-jdbc'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>application.properties</code> or <code>application.yaml</code> to point to the newly configured PostgreSQL database with username, schema, and password all set to <code>postgres</code>.
(Sigh.
I can feel Spring Security lead Rob Winch staring at me disapprovingly because of my terribad passwords: I&#8217;m trying to demonstrate something here!) Here&#8217;s the relevant configuration for <code>application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:postgresql://localhost/postgres</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">postgres</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">postgres</span>
# <b class="conum">(1)</b>
<span class="py">spring.sql.init.mode</span><span class="p">=</span><span class="s">always</span>
# <b class="conum">(2)</b>
<span class="py">spring.sql.init.schema-locations</span><span class="p">=</span><span class="s">classpath:sql/schema/*sql</span>
# <b class="conum">(3)</b>
<span class="py">spring.sql.init.data-locations</span><span class="p">=</span><span class="s">classpath:sql/data/*sql</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This tells Spring Boot to initialize the SQL database with the schema in <code>src/main/resources/schema.sql</code> and <code>src/main/resources/data.sql</code>.
Be sure to disable this property in production!</p>
</li>
<li>
<p>This tells Spring Boot to not use <code>schema.sql</code> specifically, but to instead use <em>all</em> <code>.sql</code> files in <code>src/main/resources/sql/schema/</code>.
This way, we can keep the various DDL statements separate.</p>
</li>
<li>
<p>This tells Spring Boot to not use <code>data.sql</code> specifically, but to instead use <em>all</em> <code>.sql</code> files in <code>src/main/resources/sql/data/</code>.
This way, we can keep the inserts separate.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_a_brief_note_on_passwords">A Brief Note on Passwords</h4>
<div class="paragraph">
<p>Every time you see a password in the source code of these programs, remember, this is a <em>demonstration</em>.
There are a million ways to externalize usernames and passwords from the source code and that&#8217;s going to be up to you to figure out.
Every time you see a password, you should tell yourself: that <em>should&#8217;ve been at the very least an environment variable</em>!
You shouldn&#8217;t see passwords in <code>.sql</code> files, <code>.yaml</code>, <code>.properties</code>, and especially not in <code>.java</code> source code on Github.
There are far better solutions including the Spring Cloud Config Server and the Spring Cloud Vault integration.</p>
</div>
<div class="paragraph">
<p>Also, we&#8217;re going to need to encode passwords so that they&#8217;re not lying around at rest in plain text.
Define a bean of type <code>PasswordEncoder</code> for use in your program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.authorizationserver</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.nimbusds.jose.jwk.source.JWKSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.factory.PasswordEncoderFactories</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>

    <span class="c1">// todo jwk source should be static/fixed! overide the default one</span>
<span class="c1">//    @Bean JWKSource &lt;SecurityContext&gt; jwkSource (){}</span>

    // <b class="conum">(1)</b>
    <span class="nd">@Bean</span>
    <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">PasswordEncoderFactories</span><span class="o">.</span><span class="na">createDelegatingPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is a sort of compose <code>PasswordEncoder</code>, checking the prefix of the password string for information as to which encoder to use.
We&#8217;ve already seen it action.
The <code>spring encodepassword</code>  CLI command produces a string that starts with <code>{bcrypt}&#8230;&#8203;</code>.
The default for Spring Security, today, as of this writing, is to use BCrypt.
But that may change, and when the default changes, existing passwords will continue to work because the <code>PasswordEncoder</code> will know to look for the prefix and use the older BCrypt encoder when dealing with those older passwords.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;ll use the <code>PasswordEncoder</code> more later.</p>
</div>
</div>
<div class="sect3">
<h4 id="_users_2">Users</h4>
<div class="paragraph">
<p>There are other implementations of the <code>UserDetailsService</code> interface that you can use to persist users durably.
Thinking from a more operational perspective, it&#8217;s possible you&#8217;d want to dynamically register users dynamically, rather than having to restart the Spring Authorization Server instance after you&#8217;ve updated the source code.
Spring Security has an extension of the <code>UserDetailsService</code> interface called <code>UserDetailsManager</code> which gives you explicit control over the lifecycle of <code>UserDetails</code>: adding, updating, deleting, etc.
And, as you might imagine, there&#8217;s a persistent implementation of this interface called <code>JdbcUserDetailsManager</code> that uses JDBC.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need to install some SQL schema first.
Spring Security ships with some usable schema on the classpath, but unfortunately it doesn&#8217;t work with PostgreSQL, and it&#8217;s going to fail if there are already table definitions.
So we&#8217;ll modify it accordingly, as shown in <code>src/main/resources/sql/schema/users.sql</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">users</span>
<span class="p">(</span>
    <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">password</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">enabled</span>  <span class="nb">boolean</span>      <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">authorities</span>
<span class="p">(</span>
    <span class="n">username</span>  <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">authority</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">constraint</span> <span class="n">fk_authorities_users</span> <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="k">references</span> <span class="n">users</span> <span class="p">(</span><span class="n">username</span><span class="p">),</span>
    <span class="k">constraint</span> <span class="n">username_authority</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">authority</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also define the users with SQL in a file under the <code>sql/data/</code> folder, but I want you to see what it looks like to use the Java API to programmatically register a user, so here is both the <code>UserDetailsService</code> registration and a bean that uses the <code>UserDetailsService</code> to write some data to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.authorizationserver</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.ApplicationRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.provisioning.JdbcUserDetailsManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.provisioning.UserDetailsManager</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">UsersConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nc">JdbcUserDetailsManager</span> <span class="nf">jdbcUserDetailsManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcUserDetailsManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nc">ApplicationRunner</span> <span class="nf">usersRunner</span><span class="o">(</span><span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">,</span> <span class="nc">UserDetailsManager</span> <span class="n">userDetailsManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="o">{</span>
            // <b class="conum">(1)</b>
            <span class="kt">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">roles</span><span class="o">(</span><span class="s">"USER"</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="nl">passwordEncoder:</span><span class="o">:</span><span class="n">encode</span><span class="o">);</span>
            // <b class="conum">(2)</b>
            <span class="kt">var</span> <span class="n">users</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"jlong"</span><span class="o">,</span> <span class="s">"password"</span><span class="o">,</span> <span class="s">"rwinch"</span><span class="o">,</span> <span class="s">"p@ssw0rd"</span><span class="o">);</span>
            <span class="n">users</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">userDetailsManager</span><span class="o">.</span><span class="na">userExists</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
                    <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="n">builder</span>
                            <span class="o">.</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
                    <span class="n">userDetailsManager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is a convenient pattern: define the prototype for all new users once and then reuse the builder</p>
</li>
<li>
<p>Poor Rob Winch&#8217;s eyes! why are there passwords just strewn about our Java source code?
Remember what we talked about earlier: don&#8217;t do this in production code!</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_clients">Clients</h4>
<div class="paragraph">
<p>The <code>RegisteredClientRepository</code> interface is trivial and lends itself to implementation with a persistent store.</p>
</div>
<div class="paragraph">
<p>It&#8217;s easy enough to do that here, too, with implementations of the <code>RegisteredClientRepository</code>.
There&#8217;s an implementation called <code>JdbcRegisteredClientRepository</code> that uses JDBC to manage registered clients.
It would be a fairly trivial project to implement alternatives using other persistence mechanisms like MongoDB or Hashicorp Vault.</p>
</div>
<div class="paragraph">
<p>The obvious advantage of a <code>RegisteredClientRepository</code> backed by a persistent store is that you could build a self-service registration form (or workflow) - just like Google and Apple do - for your organizations developers to register clients on demand without having to restart anything or manipulate source code.</p>
</div>
<div class="paragraph">
<p>There&#8217;s some schema on the classpath (<code>classpath:org/springframework/security/oauth2/server/authorization/client/oauth2-registered-client-schema.sql</code>) for the implementation that we need to take care to install first.
We could tell Spring Boot to run this directly, but the trouble is that it&#8217;ll fail on the second run when it executes the same DDL statements and experiences a conflict trying to create something that&#8217;s already there.
Create a new file <code>src/main/resources/sql/schema/oauth2-registered-client.sql</code> and use this DDL instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">oauth2_registered_client</span>
<span class="p">(</span>
    <span class="n">id</span>                            <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>                            <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_id</span>                     <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>                            <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_id_issued_at</span>           <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_secret</span>                 <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_secret_expires_at</span>      <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_name</span>                   <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>                            <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_authentication_methods</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>                           <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_grant_types</span>     <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>                           <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">redirect_uris</span>                 <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">post_logout_redirect_uris</span>     <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">scopes</span>                        <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>                           <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">client_settings</span>               <span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>                           <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">token_settings</span>                <span class="nb">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>                           <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s the definition of the <code>RegisteredClientRepository</code> and a runner that uses it to install a client, more or less identical to the client we registered earlier in <code>application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.authorizationserver</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.ApplicationRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.AuthorizationGrantType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.ClientAuthenticationMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.core.oidc.OidcScopes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.server.authorization.client.JdbcRegisteredClientRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.server.authorization.client.RegisteredClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">ClientsConfiguration</span> <span class="o">{</span>

    // <b class="conum">(1)</b>
    <span class="nd">@Bean</span>
    <span class="nc">RegisteredClientRepository</span> <span class="nf">registeredClientRepository</span><span class="o">(</span><span class="nc">JdbcTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcRegisteredClientRepository</span><span class="o">(</span><span class="n">template</span><span class="o">);</span>
    <span class="o">}</span>

    //<b class="conum">(2)</b>
    <span class="nd">@Bean</span>
    <span class="nc">ApplicationRunner</span> <span class="nf">clientsRunner</span><span class="o">(</span><span class="nc">RegisteredClientRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">"crm"</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">repository</span><span class="o">.</span><span class="na">findByClientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span>
                        <span class="nc">RegisteredClient</span>
                                <span class="o">.</span><span class="na">withId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">())</span>
                                <span class="o">.</span><span class="na">clientId</span><span class="o">(</span><span class="n">clientId</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">clientSecret</span><span class="o">(</span><span class="s">"{bcrypt}$2a$10$m7dGi0viwVH63EjwZc6UdeUQxPuiVEEdFbZFI9nMxHAASTOIDlaVO"</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">clientAuthenticationMethod</span><span class="o">(</span><span class="nc">ClientAuthenticationMethod</span><span class="o">.</span><span class="na">CLIENT_SECRET_BASIC</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">authorizationGrantTypes</span><span class="o">(</span><span class="n">grantTypes</span> <span class="o">-&gt;</span> <span class="n">grantTypes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
                                        <span class="nc">AuthorizationGrantType</span><span class="o">.</span><span class="na">CLIENT_CREDENTIALS</span><span class="o">,</span>
                                        <span class="nc">AuthorizationGrantType</span><span class="o">.</span><span class="na">AUTHORIZATION_CODE</span><span class="o">,</span>
                                        <span class="nc">AuthorizationGrantType</span><span class="o">.</span><span class="na">REFRESH_TOKEN</span><span class="o">)))</span>
                                <span class="o">.</span><span class="na">redirectUri</span><span class="o">(</span><span class="s">"http://127.0.0.1:8082/login/oauth2/code/spring"</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="n">scopes</span> <span class="o">-&gt;</span> <span class="n">scopes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"user.read"</span><span class="o">,</span> <span class="s">"user.write"</span><span class="o">,</span> <span class="nc">OidcScopes</span><span class="o">.</span><span class="na">OPENID</span><span class="o">)))</span>
                                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                <span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>register the <code>RegisteredClientRepository</code></p>
</li>
<li>
<p>this installs a registered client that&#8217;s more or less equivalent to what we saw earlier in the <code>application.yml</code> properties file.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_authorizations">Authorizations</h4>
<div class="paragraph">
<p>Remember that bit where you got redirected to the Spring Authorization Server and had to click a checkbox to confirm that the user had <code>user.read</code> scope?
That fact - the consent of the scope - is stored in memory by default, but it could be stored in a database too.
(Big surprise, I know!)</p>
</div>
<div class="paragraph">
<p>There are two interfaces of note here: <code>OAuth2AuthorizationService</code> and <code>OAuth2AuthorizationConsentService</code>.</p>
</div>
<div class="paragraph">
<p><code>OAuth2AuthorizationService</code> handles representations of an authorization - the JWT token, the client, etc.
It&#8217;s the same story as before: there&#8217;s schema on the classpath (<code>org/springframework/security/oauth2/server/authorization/oauth2-authorization-schema.sql</code>) but it doesn&#8217;t work with PostgresSQL and, importantly, even if it did it would fail on the second run through because Spring Boot would try to define the table twice, in effect.
So we&#8217;ll modify it.
Create a file <code>src/main/resources/sql/schema/oauth2-authorization-schema.sql</code>.
The changes we&#8217;ve made replace all <code>blob</code> types with <code>text</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">oauth2_authorization</span>
<span class="p">(</span>
    <span class="n">id</span>                            <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">registered_client_id</span>          <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">principal_name</span>                <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_grant_type</span>      <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorized_scopes</span>             <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">attributes</span>                    <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">state</span>                         <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_code_value</span>      <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_code_issued_at</span>  <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_code_expires_at</span> <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorization_code_metadata</span>   <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_value</span>            <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_issued_at</span>        <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_expires_at</span>       <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_metadata</span>         <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_type</span>             <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">access_token_scopes</span>           <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">oidc_id_token_value</span>           <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">oidc_id_token_issued_at</span>       <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">oidc_id_token_expires_at</span>      <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">oidc_id_token_metadata</span>        <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">refresh_token_value</span>           <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">refresh_token_issued_at</span>       <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">refresh_token_expires_at</span>      <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">refresh_token_metadata</span>        <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_code_value</span>               <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_code_issued_at</span>           <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_code_expires_at</span>          <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_code_metadata</span>            <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">device_code_value</span>             <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">device_code_issued_at</span>         <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">device_code_expires_at</span>        <span class="nb">timestamp</span>     <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">device_code_metadata</span>          <span class="nb">text</span>          <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>OAuth2AuthorizationConsentService</code> handles representations of an OAuth 2.0 "consent" to an Authorization request, which holds state related to the set of authorities granted to a client by the resource owner.
It&#8217;s the same story as before: there&#8217;s schema on the classpath (<code>org/springframework/security/oauth2/server/authorization/oauth2-authorization-consent-schema.sql</code>) but it doesn&#8217;t work with PostgresSQL and, importantly, even if it did it would fail on the second run through because Spring Boot would try to define the table twice, in effect.
So we&#8217;ll modify it.
Create a file <code>src/main/resources/sql/schema/oauth2-authorization-consent-schema.sql</code>.
The changes we&#8217;ve made replace all <code>blob</code> types with <code>text</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">oauth2_authorization_consent</span>
<span class="p">(</span>
    <span class="n">registered_client_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">principal_name</span>       <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">authorities</span>          <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">registered_client_id</span><span class="p">,</span> <span class="n">principal_name</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_http_sessions_themselves">The HTTP Sessions themselves</h4>
<div class="paragraph">
<p>The final piece of the persistence pie is to persist the actual HTTP sessions themselves.
Spring Authorization Server assumes a Servlet container is present somewhere.
By default, Spring Boot uses Apache Tomcat, though that&#8217;s very configurable.
And Apache Tomcat, in turn, provides session management features consistent with the HTTP Servlet specification.
It&#8217;s even got pluggable HTTP session management, meaning you can plugin other implementations of Apache Tomcat&#8217;s proprietary abstraction.
But this isn&#8217;t easy, or portable.
Indeed, any web server is going to have some rudimentary HTTP session management, but session clustering and replication, consistency checks, etc., are not their _raison d&#8217;être: serving HTTP requests is.</p>
</div>
<div class="paragraph">
<p>Spring Session can help.
It wraps the containers' default <code>HttpSession</code>.
All interactions you have pass through the wrapper, which in turn delegates to any of a number of implementations backed by technology that is far faster and more reliable in the ways of making data consistently available.You can use implementations for, among other things, Hazelcast, Redis, and of course any 'ol SQL <code>DataSource</code>.
We&#8217;re choosing to continue to leverage our investment in PostgreSQL, so we&#8217;ll use the Spring Session JDBC module.</p>
</div>
<div class="paragraph">
<p>Add the following dependency to the build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">	<span class="n">implementation</span> <span class="s1">'org.springframework.session:spring-session-jdbc'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a property, <code>spring.session.jdbc.initialize-schema=always</code>, that once specified will cause Spring Session to install the JDBC schema for you in the database.
It worked for me (surprise!), in PostgreSQL.
But, I just really want the schema to all be in one place where I can version control it, audit it, etc, so here&#8217;s the schema.
Create a file <code>src/main/resources/sql/schema/spring-session-jdbc.sql</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="c1">-- sessions</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">spring_session</span>
<span class="p">(</span>
    <span class="n">primary_id</span>            <span class="nb">character</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">primary</span> <span class="k">key</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">session_id</span>            <span class="nb">character</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>             <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">creation_time</span>         <span class="nb">bigint</span>                    <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">last_access_time</span>      <span class="nb">bigint</span>                    <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">max_inactive_interval</span> <span class="nb">integer</span>                   <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">expiry_time</span>           <span class="nb">bigint</span>                    <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">principal_name</span>        <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">spring_session_ix1</span> <span class="k">on</span> <span class="n">spring_session</span> <span class="k">using</span> <span class="n">btree</span> <span class="p">(</span><span class="n">session_id</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">spring_session_ix2</span> <span class="k">on</span> <span class="n">spring_session</span> <span class="k">using</span> <span class="n">btree</span> <span class="p">(</span><span class="n">expiry_time</span><span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">spring_session_ix3</span> <span class="k">on</span> <span class="n">spring_session</span> <span class="k">using</span> <span class="n">btree</span> <span class="p">(</span><span class="n">principal_name</span><span class="p">);</span>

<span class="c1">-- session attributes</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">spring_session_attributes</span>
<span class="p">(</span>
    <span class="n">session_primary_id</span> <span class="nb">character</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>          <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">attribute_name</span>     <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">attribute_bytes</span>    <span class="n">bytea</span>                  <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">session_primary_id</span><span class="p">,</span> <span class="n">attribute_name</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span> <span class="p">(</span><span class="n">session_primary_id</span><span class="p">)</span> <span class="k">references</span> <span class="n">spring_session</span> <span class="p">(</span><span class="n">primary_id</span><span class="p">)</span>
        <span class="k">match</span> <span class="k">simple</span> <span class="k">on</span> <span class="k">update</span> <span class="k">no</span> <span class="n">action</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">cascade</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it!
Restart the Spring Authorization Server.
Now you can run more than one instance of the Spring Authorization Server behind a load balancer, and no matter to which instance a client and its cookies present themselves, the container will resolve the session from the PostgreSQL database.
By the way, is now a good time to remind you not to stash sensitive stuff in the HTTP session?
You never know when it&#8217;s going to be serialized to some datastore&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_protecting_a_simple_http_api">Protecting a Simple HTTP API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s build an HTTP API.
Honestly, this is just a pretense to have something to secure with the Spring Security OAuth support, so we&#8217;ll make this quick.
First, go to the <a href="https://start.spring.io">Spring Initializr</a>, and then add the following dependencies: `</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Spring for RabbitMQ</code></p>
</li>
<li>
<p><code>Spring Integration</code></p>
</li>
<li>
<p><code>Spring Web</code></p>
</li>
<li>
<p><code>OAuth2 Resource Server</code></p>
</li>
<li>
<p><code>Spring Data JDBC</code></p>
</li>
<li>
<p><code>PostgreSQL Driver</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I gave the newly minted project a group of <code>bootiful</code> and named it <code>api</code>.
Click <code>Generate</code>, unzip the newly minted <code>.zip</code> file, and then open the project in your IDE.</p>
</div>
<div class="paragraph">
<p>The domain&#8217;s a trivial one: customer data, like a CRM.
Each <code>Customer</code> entity has an <code>id</code> field, a <code>name</code> field, and an <code>email</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>

<span class="n">record</span> <span class="nf">Customer</span><span class="o">(</span><span class="nd">@Id</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course there&#8217;s a Spring Data JDBC repository to make working with that data easier&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.repository.ListCrudRepository</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">CustomerRepository</span> <span class="kd">extends</span> <span class="nc">ListCrudRepository</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Customer</span> <span class="nf">findCustomerById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Data JDBC repository talks to a SQL table, called <code>customer</code>, whose definition we must specify.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">customer</span>
<span class="p">(</span>
    <span class="n">id</span>    <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>  <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">email</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s insert some <code>customer</code> records, just for good measure, so that we have something to look at, and so that the system is in a well-known state.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">delete</span> <span class="k">from</span> <span class="n">customer</span><span class="p">;</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Violetta Giorgieva'</span><span class="p">,</span> <span class="s1">'vg@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Madhura Bhave'</span> <span class="p">,</span> <span class="s1">'mb@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'David Syer'</span>  <span class="p">,</span><span class="s1">'ds@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Josh Long'</span> <span class="p">,</span> <span class="s1">'jl@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Stéphane Nicoll'</span> <span class="p">,</span> <span class="s1">'sn@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Jürgen Hoeller'</span> <span class="p">,</span> <span class="s1">'jh@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Audrey Neveu'</span> <span class="p">,</span> <span class="s1">'an@email.com'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">customer</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">email</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Yuxin Bae'</span> <span class="p">,</span> <span class="s1">'yb@email.com'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And an HTTP controller that will return all that customer data&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">CustomerHttpController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomerRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nc">CustomerHttpController</span><span class="o">(</span><span class="nc">CustomerRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/customers"</span><span class="o">)</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Customer</span><span class="o">&gt;</span> <span class="nf">customers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember we&#8217;re going to be securing this with Spring Security&#8217;s OAuth support, and just to be sure everything&#8217;s worked, we&#8217;ll have a simple HTTP endpoint that injects and then spits out the current authenticated user&#8217;s username (so you can see who the system thinks is authenticated at the moment).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.Principal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@ResponseBody</span>
<span class="kd">class</span> <span class="nc">MeHttpController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/me"</span><span class="o">)</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">principal</span><span class="o">(</span><span class="nc">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">principal</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And, finally, we&#8217;ve got a little integration that sends a message using the AMQP protocol via RabbitMQ to another service called <code>processor</code>.
We&#8217;ll introduce that thing later.
The idea is that you&#8217;ll be able to click a button to get some sort of email sent to each user.
I haven&#8217;t really thought out what sort of email.
Just use your imagination.
Sending email is one of those things you don&#8217;t necessarily want to do in the hot path of handling HTTP requests.
It takes a while, is prone to failing for no good reason, etc.
It&#8217;s one of those things that might also scale independently of the HTTP API itself, so we&#8217;ve put it on the other end of a message queue.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This is what we used to call a backoffice process.
I&#8217;m calling it <code>processor</code>, because I&#8217;m amazing with names, like everyone on the Spring team is.
We named our MVC framework Spring MVC, our data framework Spring Data, our Batch framework Spring Batch.. well, you get the idea.
(Don&#8217;t ask about Spring Boot, tho!)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Requests originate here in this controller.
Each request contains a <code>Customer</code> payload, and header, <code>jwt</code>, which contains the JWT associated with the current authenticated user.
We&#8217;ll use that JWT later to validate the request is from a trusted, authenticated, user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.MessageBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.annotation.AuthenticationPrincipal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.jwt.Jwt</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@ResponseBody</span>
<span class="kd">class</span> <span class="nc">EmailController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MessageChannel</span> <span class="n">requests</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CustomerRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nc">EmailController</span><span class="o">(</span><span class="nc">CustomerRepository</span> <span class="n">repository</span><span class="o">,</span> <span class="nc">MessageChannel</span> <span class="n">requests</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">requests</span> <span class="o">=</span> <span class="n">requests</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/email"</span><span class="o">)</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">email</span><span class="o">(</span>
            <span class="nd">@AuthenticationPrincipal</span> <span class="nc">Jwt</span> <span class="n">jwt</span><span class="o">,</span>
            <span class="nd">@RequestParam</span> <span class="nc">Integer</span> <span class="n">customerId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="o">=</span> <span class="nc">MessageBuilder</span>
                <span class="o">.</span><span class="na">withPayload</span><span class="o">(</span><span class="n">repository</span><span class="o">.</span><span class="na">findCustomerById</span><span class="o">(</span><span class="n">customerId</span><span class="o">))</span>
                <span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"jwt"</span><span class="o">,</span> <span class="n">token</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">sent</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">requests</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"sent"</span><span class="o">,</span> <span class="n">sent</span><span class="o">,</span> <span class="s">"customerId"</span><span class="o">,</span> <span class="n">customerId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there&#8217;s a bit of Spring Integration plumbing to route those requests to our RabbitMQ broker running in a separate process.
This <code>IntegrationFlow</code> looks at requests (which come in the shape of a <code>Message&lt;T&gt;</code> object, which has headers and a payload) coming in from the injected <code>MessageChannel</code>, transforms them into JSON data, and then sends them, along with a JWT token associated to the current authenticated user, on to the broker, where it&#8217;ll eventually get delivered to the consumer, <code>processor</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.AmqpTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.integration.amqp.dsl.Amqp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.integration.dsl.DirectChannelSpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.integration.dsl.IntegrationFlow</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.integration.dsl.MessageChannels</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.integration.json.ObjectToJsonTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageChannel</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">EmailRequestsIntegrationFlowConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">destinationName</span> <span class="o">=</span> <span class="s">"emails"</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="nc">IntegrationFlow</span> <span class="nf">emailRequestsIntegrationFlow</span><span class="o">(</span><span class="nc">MessageChannel</span> <span class="n">requests</span><span class="o">,</span> <span class="nc">AmqpTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
        // <b class="conum">(1)</b>
        <span class="kt">var</span> <span class="n">outboundAmqpAdapter</span> <span class="o">=</span> <span class="nc">Amqp</span>
                <span class="o">.</span><span class="na">outboundAdapter</span><span class="o">(</span><span class="n">template</span><span class="o">)</span>
                <span class="o">.</span><span class="na">routingKey</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">destinationName</span><span class="o">);</span>

        <span class="k">return</span> <span class="nc">IntegrationFlow</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">requests</span><span class="o">)</span>// <b class="conum">(2)</b>
                <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="nc">ObjectToJsonTransformer</span><span class="o">())</span> // <b class="conum">(3)</b>
                <span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">outboundAmqpAdapter</span><span class="o">)</span> // <b class="conum">(4)</b>
                <span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nc">DirectChannelSpec</span> <span class="nf">requests</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">MessageChannels</span><span class="o">.</span><span class="na">direct</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>inbound adapters translate events from the real world into Spring Framework <code>Message&lt;T&gt;</code> objects.
Outbound adapters translate <code>Message&lt;T&gt;</code> objects into events in the real world.
This adapter lets us interface with RabbitMQ via the AMQP protocol.</p>
</li>
<li>
<p>In this case, messages pass through the <code>MessageChannel</code>&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;and into the next stage in the flow, a transformer, which will translate the <code>Message&lt;Customer&gt;</code> into a <code>Message&lt;String&gt;</code>, with a JSON payload</p>
</li>
<li>
<p>and from there, it gets routed to the outbound AMQP adapter, which will translate the Spring Framework <code>Message&lt;String&gt;</code> into a request sent over AMQP to the RabbitMQ broker</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;re using Spring Security&#8217;s Resource Server support to protect requests to the API, rejecting requests that don&#8217;t have a valid OAuth 2 token.
It does this by connecting to the OAuth 2 IDP (our amazing Spring Authorization Server instance) and validating the JWT.</p>
</div>
<div class="paragraph">
<p>The Spring Security Resource Server support, the Spring Data support, the Spring Integration AMQP support, all of it requires configuration, which brings us to our <code>application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"># <b class="conum">(1)</b>
<span class="py">spring.security.oauth2.resourceserver.jwt.issuer-uri</span><span class="p">=</span><span class="s">http://localhost:8080</span>

# <b class="conum">(2)</b>
<span class="py">spring.rabbitmq.username</span><span class="p">=</span><span class="s">user</span>
<span class="py">spring.rabbitmq.password</span><span class="p">=</span><span class="s">password</span>
<span class="py">spring.sql.init.mode</span><span class="p">=</span><span class="s">always</span>

# <b class="conum">(3)</b>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">postgres</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">postgres</span>
<span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:postgresql://localhost/postgres</span>

# <b class="conum">(4)</b>
<span class="py">server.port</span><span class="p">=</span><span class="s">8081</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the issuer URI is the address of the Spring Authorization Server against which Spring Security can validate a JWT token</p>
</li>
<li>
<p>we need to connect to the RabbitMQ instance..</p>
</li>
<li>
<p>and the PostgresSQL database&#8230;&#8203;</p>
</li>
<li>
<p>the Spring Authorization Server is already running on port <code>8080</code>, so we&#8217;ll need to run this Java application on port <code>8081</code>.
(Remember that!)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With all that in place, you should be able to start the application.
It&#8217;s got a REST endpoint.
You can try it out by hitting the new <code>/customers</code> endpoint that we created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">curl http://localhost:8081/customers</code></pre>
</div>
</div>
<div class="paragraph">
<p>But it fails!
Which is good.
It fails because it&#8217;s an authenticated request.
We need a valid JWT token.
We can get one because, when we registered the client with the Spring Authorization Server, we listed <code>client_credentials</code> as an authorized grant type.
This in turn allows us to make a request without a user context.
And if there&#8217;s no user, then there&#8217;s no need to verify the user, and thus no need for a browser or a web page or anything.
We only need the client ID and client secret: <code>crm</code>/<code>crm</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">curl <span class="nt">-X</span> POST <span class="se">\</span>
     <span class="nt">-H</span> <span class="s2">"Authorization: Basic </span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'crm:crm'</span> | <span class="nb">base64</span><span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
     <span class="nt">-H</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span> <span class="se">\</span>
     <span class="nt">-d</span> <span class="s2">"grant_type=client_credentials&amp;scope=user.read"</span> <span class="se">\</span>
     http://localhost:8080/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>That should dump a token in a JSON document.
On my machine I got this very long JSON document that I&#8217;ve abbreviated for you here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"access_token"</span><span class="p">:</span><span class="s2">"eyJraWQiOiI4YzQyNGU...Qy1Fg"</span><span class="p">,</span><span class="nl">"scope"</span><span class="p">:</span><span class="s2">"user.read"</span><span class="p">,</span><span class="nl">"token_type"</span><span class="p">:</span><span class="s2">"Bearer"</span><span class="p">,</span><span class="nl">"expires_in"</span><span class="p">:</span><span class="mi">299</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The important bit is the <code>access_token</code> attribute.
If you have the  <code>jq</code> command line utility installed, you can extract out the <code>access_token</code> like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">TOKEN</span><span class="o">=</span><span class="si">$(</span> curl <span class="nt">-X</span> POST <span class="se">\</span>
     <span class="nt">-H</span> <span class="s2">"Authorization: Basic </span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'crm:crm'</span> | <span class="nb">base64</span><span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
     <span class="nt">-H</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded"</span> <span class="se">\</span>
     <span class="nt">-d</span> <span class="s2">"grant_type=client_credentials&amp;scope=user.read"</span> <span class="se">\</span>
     http://localhost:8080/oauth2/token | jq <span class="nt">-r</span>  .access_token <span class="si">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By the way, you could also issue the same request using Spring&#8217;s <code>RestTemplate</code> or <code>WebClient</code> or <code>RestClient</code>.
Here&#8217;s the equivalent using ye ole <code>RestTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.api</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.JsonNode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.LinkedMultiValueMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ClientCredentialsClient</span> <span class="o">{</span>

    <span class="nc">String</span> <span class="nf">getJwtToken</span><span class="o">(</span><span class="nc">RestTemplate</span> <span class="n">restTemplate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">clientSecret</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setBasicAuth</span><span class="o">(</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>
        <span class="n">body</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"grant_type"</span><span class="o">,</span> <span class="s">"client_credentials"</span><span class="o">);</span>
        <span class="n">body</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"scope"</span><span class="o">,</span> <span class="s">"user.read"</span><span class="o">);</span>

        <span class="kt">var</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpEntity</span><span class="o">&lt;&gt;(</span><span class="n">body</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
        <span class="kt">var</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8080/oauth2/token"</span><span class="o">;</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">postForEntity</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">entity</span><span class="o">,</span> <span class="nc">JsonNode</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">().</span><span class="na">is2xxSuccessful</span><span class="o">(),</span> <span class="s">"the response needs to be 200x"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"access_token"</span><span class="o">).</span><span class="na">asText</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use this token to then issue a request to the HTTP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">curl <span class="nt">-H</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span> http://localhost:8081/customers</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there&#8217;s the data!
At long last, reunited with the data.
Feels good doesn&#8217;t it?
We&#8217;ve got an HTTP API that is secure and all we had to do was specify the <code>issuer-uri</code> int he property file.
Our Spring Authorization Server is paying dividends already!
We&#8217;ve got honest-to-goodness identity management, security, and more, all for the cost of one lousy little property.
And if we want to protect any other microservices, its the same story.
One little <code>issuer-uri</code> property, and our services will automatically be protected and automatically be able to work with the identities in the centralized Spring Authorization Server.</p>
</div>
<div class="paragraph">
<p>I love this for us.
We did something amazing here.
Do you feel the possibilities?
We stood up one little Spring Authorization Server and suddenly every microservice in our system can be protected.
No need to redundantly duplicate the requests.</p>
</div>
<div class="paragraph">
<p>We sort of cheated here, though.
We got a token using the <code>client_credentials</code> authorization grant type.
No user context, remember?
We <em>want</em> users.
That&#8217;s sort of the point of this whole exercise.
Somewhere, somehow, we&#8217;ll need to get a user involved.
Once they&#8217;re involved, they&#8217;ll have a token that we can use to make requests to this resource server.
The thing that originates the token, that forces the redirect to the OAuth IDP where the user will be asked to consent?
That&#8217;s called an OAuth 2 client.
An OAuth 2 client is both an OAuth 2 resource server, in that it&#8217;ll reject invalid requests, <em>and</em> it has this extra ability to initiate and handle the OAuth flow - the "OAuth dance" - we looked at earlier when we discussed Yelp.com&#8217;s authentication flow.
Let&#8217;s build one.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_gateway_client">The Gateway Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our super secure OAuth onion, this next microservice, the <code>gateway</code>, is the outermost layer.
It is the first port-of-call for all requests destined for the microservices in our system.
When visitors to our site punch in the domain name for our system into a browser, it&#8217;ll resolve to a loadbalancer serving this gateway service, and it is here where we&#8217;ll originate an OAuth token.
This service is also a gateway, powered by Spring Cloud Gateway.
The gateway acts as a proxy, allowing us to forward requests to different hosts and ports, concealing from the user that the responses they&#8217;re seeing are from different services.</p>
</div>
<div class="paragraph">
<p>The <code>gateway</code> service&#8217;s job is entirely to handle the OAuth dance - if it detects that the request is not authenticated - and to proxy requests to two other HTTP endpoints: the <code>api</code> we just built, and have running on port <code>8081</code>, and the static HTML process running on port <code>8020</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the routing table</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>HTTP origin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>HTTP destination</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gateway:8082/api/customers" class="bare">http://gateway:8082/api/customers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://api:8080/customers" class="bare">http://api:8080/customers</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gateway:8082/api/me" class="bare">http://gateway:8082/api/me</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://api:8080/me" class="bare">http://api:8080/me</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gateway:8082/api/email" class="bare">http://gateway:8082/api/email</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://api:8080/email" class="bare">http://api:8080/email</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gateway:8082/index.html" class="bare">http://gateway:8082/index.html</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://static:8020/index.html" class="bare">http://static:8020/index.html</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>gateway</code> also sends along the JWT token to the downstream HTTP endpoints, acting as a token relay.
The <code>static</code> site won&#8217;t care (it&#8217;s just serving up static <code>.html</code> and <code>.css</code> files, after all), but the <code>api</code> will.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the Java code first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.gateway</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.Customizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.web.server.ServerHttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.server.SecurityWebFilterChain</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="o">{</span>

    // <b class="conum">(1)</b>
    <span class="nd">@Bean</span>
    <span class="nc">SecurityWebFilterChain</span> <span class="nf">securityWebFilterChain</span><span class="o">(</span><span class="nc">ServerHttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeExchange</span><span class="o">((</span><span class="n">authorize</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">authorize</span><span class="o">.</span><span class="na">anyExchange</span><span class="o">().</span><span class="na">authenticated</span><span class="o">())</span>//<b class="conum">(2)</b>
                <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="nc">ServerHttpSecurity</span><span class="o">.</span><span class="na">CsrfSpec</span><span class="o">::</span><span class="n">disable</span><span class="o">)</span>// <b class="conum">(3)</b>
                <span class="o">.</span><span class="na">oauth2Login</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">())</span>//<b class="conum">(4)</b>
                <span class="o">.</span><span class="na">oauth2Client</span><span class="o">(</span><span class="nc">Customizer</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>you could probably get away with not defining this bean at all <em>if</em> you were willing to deal with default behavior of CSRF tokens, which I am not.
In the interest of simplicity, I&#8217;m disabling them, but in so doing I am also disabling all the other things Spring Security assumed I wanted.
So we will also go through and re-enable those things.</p>
</li>
<li>
<p>We want all HTTP requests to be authenticated&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;and to disable the CSRF support&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;and to re-enable OAuth 2 OIDC login support and the OAuth 2 client support.
The OIDC login functionality is what triggers the OAuth dance we&#8217;ve talked about.
The OAuth 2 client support is what tells Spring Security, running in this process, as which OAuth 2 client requests for OIDC login should be done.
We&#8217;ll need to specify the particulars in the property configuration later.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The security configuration is pretty straightforward.
We&#8217;re an OAuth client.
We want to prompt users to login with a particular client.
Once a user is authenticated, well, there&#8217;s not much for them to see!
We need Spring Cloud Gateway to connect our other HTTP services to the user visiting this <code>gateway</code> service.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll configure two Spring Cloud Gateway <em>routes</em>.
Each request has a predicate, optional filter(s), and a destination URI.
The predicate defines how requests to the Spring Cloud Gateway service are matched, e.g.: does this request have a particular header or cookie, or a particlar path, or a particular virtual host?
You may specify one or more filters that act on the incoming requests, changing it.
Finally, the request, after it has passed through any and all filters, is sent to a final destination, which we specify with a URI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.gateway</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.gateway.route.RouteLocator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">GatewayConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nc">RouteLocator</span> <span class="nf">gateway</span><span class="o">(</span><span class="nc">RouteLocatorBuilder</span> <span class="n">rlb</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">apiPrefix</span> <span class="o">=</span> <span class="s">"/api/"</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">rlb</span>
                <span class="o">.</span><span class="na">routes</span><span class="o">()</span>
                // <b class="conum">(1)</b>
                <span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="n">rs</span> <span class="o">-&gt;</span> <span class="n">rs</span>
                        <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">apiPrefix</span> <span class="o">+</span> <span class="s">"**"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">filters</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span>
                                <span class="o">.</span><span class="na">tokenRelay</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">rewritePath</span><span class="o">(</span><span class="n">apiPrefix</span> <span class="o">+</span> <span class="s">"(?&lt;segment&gt;.*)"</span><span class="o">,</span> <span class="s">"/$\\{segment}"</span><span class="o">)</span>
                        <span class="o">)</span>
                        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"http://localhost:8081"</span><span class="o">))</span>
                // <b class="conum">(2)</b>
                <span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="n">rs</span> <span class="o">-&gt;</span> <span class="n">rs</span>
                        <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">"http://localhost:8020"</span><span class="o">)</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the first route matches all requests to <code>/api/**</code>, notes and forwards any OAuth JWTs to the backend service, and changes the path of the request from <code>gateway:8082/api/foo</code> to <code>api:8081/foo</code>, dropping the <code>/api/</code> bit.</p>
</li>
<li>
<p>the second route takes every other request and sends it unchecked on to the HTTP endpoint service up the static HTMl 5 and JavaScript assets.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That&#8217;s just about all the Java code for this service, but its role and importance in the architecture can not be overstated.
Let&#8217;s look at the property file that ties it all together.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"># <b class="conum">(1)</b>
<span class="py">server.port</span><span class="p">=</span><span class="s">8082</span>
# <b class="conum">(2)</b>
<span class="py">spring.security.oauth2.client.provider.spring.issuer-uri</span><span class="p">=</span><span class="s">http://localhost:8080</span>
# <b class="conum">(3)</b>
<span class="py">spring.security.oauth2.client.registration.spring.provider</span><span class="p">=</span><span class="s">spring</span>
<span class="py">spring.security.oauth2.client.registration.spring.client-id</span><span class="p">=</span><span class="s">crm</span>
<span class="py">spring.security.oauth2.client.registration.spring.client-secret</span><span class="p">=</span><span class="s">crm</span>
<span class="py">spring.security.oauth2.client.registration.spring.authorization-grant-type</span><span class="p">=</span><span class="s">authorization_code</span>
<span class="py">spring.security.oauth2.client.registration.spring.client-authentication-method</span><span class="p">=</span><span class="s">client_secret_basic</span>
<span class="py">spring.security.oauth2.client.registration.spring.redirect-uri</span><span class="p">=</span><span class="s">{baseUrl}/login/oauth2/code/{registrationId}</span>
<span class="py">spring.security.oauth2.client.registration.spring.scope</span><span class="p">=</span><span class="s">user.read,openid</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this process will run on port <code>8082</code>.</p>
</li>
<li>
<p>it will use the issuer URI to validate JWTs if it detects them</p>
</li>
<li>
<p>otherwise it will use this configuration to, acting as a client, inintiate an OIDC login to allow you to come up with a valid token.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_your_first_cup_of_java">Your First Cup of Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"WARNING: Spoilers ahead!" That is what I think every chapter or indeed every bit of informative text should say upfront because, by its very nature, the new knowledge and insight gained from such a chapter spells out the nuances of the unknown topic that it treats.
But, unfortunately, most texts forego that friendly warning.
Well, I didn&#8217;t: there are <em>spoilers</em> ahead!</p>
</div>
<div class="paragraph">
<p>Some of you will probably appreciate the warning.
Because some of you have not upgraded to Java 11, let alone Java 17. I can only assume you are saving the surprise for some special day, years in the future?
I don&#8217;t know what the reason is, but I hope you&#8217;re able to move up and over soon because Spring Framework 6 and Spring Boot 3 assume a Java 17 baseline.
That means that not only do those generations of Spring support Java 17 features (as did the Spring Framework 5 and Spring Boot generations), they also use some Java 17 features in their source code.
This book doesn&#8217;t use Spring Framework 6 and Spring Boot 3 yet, but it will assume a Java 17 baseline for the code herein.</p>
</div>
<div class="paragraph">
<p>Whatever the cause of your hesitation, this chapter contains <em>spoilers</em>!
If you don&#8217;t mind spoilers, let&#8217;s dive right in!</p>
</div>
<div class="paragraph">
<p>First things first: you need an OpenJDK distribution that works for you.
The list of valid and viable distributions scrolls down to the floor and out the door, so I&#8217;ll refer you to Fooojay.io&#8217;s <a href="https://foojay.io/almanac/java-17/">handy version almanac for Java 17</a>.
One of my favorite tools for managing my Java installations on UNIX-y type operating systems is <a href="https://sdkman.io/"><code>sdkman</code></a>.
It works on macOS, Windows Subsystem for Linux (WSL), Linux, and I&#8217;m sure other places besides.
I use the <a href="https://www.graalvm.org/">GraalVM</a> distribution.
GraalVM is an OpenJDK distribution with some extra features, including ahead-of-time native image compilation.
To get that distribution, you might say:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">sdk <span class="nb">install </span>java 17.0.7-graalce <b class="conum">(1)</b>
sdk default java 17.0.7-graalce <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the first command installs the latest version of the GraalVM distribution of Java 17</p>
</li>
<li>
<p>the second makes it the default installed distribution on my box so that all my interactions with Java are going to that distribution</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With that done, let&#8217;s look at some neat features in Java&#8217;s latest and greatest versions up until Java 17.</p>
</div>
<div class="sect2">
<h3 id="_operations_improvements">Operations Improvements</h3>
<div class="paragraph">
<p>The newer versions of Java now support something called CDS Archives.
CDS Archives essentially capture some of the invariant (but freshly computed) state from a given application and cache it for easy reuse on subsequent runs.
I consistently shave 0.1 or 0.2 seconds from startup time when using CDS Archives.</p>
</div>
<div class="paragraph">
<p>The newer versions of Java are also container aware.
So, let&#8217;s suppose you are running Docker images on your host machine, which has 32GB of RAM.
You might configure the JRE with 2GB of RAM and errantly configure the Docker container with only 1GB of RAM.
Java would see the 32GB and think it could allocate 2GB and then fail to startup.
Java is aware of the container&#8217;s limited RAM in newer versions and won&#8217;t exceed it.</p>
</div>
<div class="paragraph">
<p>Java Flight Recorder (JEP 328) monitors and profiles running Java applications.
Even better, it does so with a low runtime footprint.
Java Mission Control allows ingesting and visualizing Java Flight Recorder data.
Java Mission Control takes Java&#8217;s already stellar support for observability to the next level.</p>
</div>
</div>
<div class="sect2">
<h3 id="_performance">Performance</h3>
<div class="paragraph">
<p>Java 17 is <em>fast</em> and reliable.</p>
</div>
<div class="paragraph">
<p>Java&#8217;s garbage collector is the stuff of legend.
It&#8217;s fast, lightweight, and minimally invasive.
It&#8217;s also one of those things where, when it&#8217;s improved, your application&#8217;s runtime improves with it, for free.
No recompilation is required.</p>
</div>
<div class="paragraph">
<p>G1 has been the default garbage collector since Java 9, replacing the Parallel garbage collector in Java 8. It reduces pause times with the default Parallel GC from Java 8, though it may have lower throughput overall.
Next, Java 11 introduced the ZGC garbage collector to reduce pauses further.
Finally, Java 14 introduced the Shenandoah GC, which keeps pause times low and does so in a manner independent of the heap&#8217;s size.</p>
</div>
<div class="paragraph">
<p>And it&#8217;s fast.
I can&#8217;t give you a specific number or anything because it is so highly workload-sensitive, but <a href="https://www.optaplanner.org/blog/2021/09/15/HowMuchFasterIsJava17.html">this post from the folks at OptaPlanner</a> is persuasive.
They saw an average of 8.66% improvement for their CPU-intensive workloads when using the G1 GC, measured after a discarded 30 second warmup period.
These numbers reflect the jump from Java 11 (not Java 8) to Java 17. I can only imagine the numbers from Java 8 to Java 17 are even better.
And that number is just an average: some workloads improved by as much as 23%!</p>
</div>
</div>
<div class="sect2">
<h3 id="_autocloseable">Autocloseable</h3>
<div class="paragraph">
<p>Java manages most memory for you, but it can&#8217;t be responsible for the state outside of the humble confines of the JVM.
So, for example, you wouldn&#8217;t like it if Java <em>garbage collected</em> your connection to the database, and you wouldn&#8217;t like it if Java garbage-collected your open socket connections without warning.
Therefore, the interfaces you use to interact with these external resources typically have a <code>close()</code> method that you, the client, need to call when working the external resource finishes.</p>
</div>
<div class="paragraph">
<p>You mustn&#8217;t neglect to call that method!
Don&#8217;t be greedy!
You&#8217;re not greedy, are ya?
You want to leave the JVM as clean as you found it.
So, you write the boilerplate.
We all know the boilerplate: open the resource; work with it; surround that work with a <code>try</code>/<code>catch</code>/<code>finally</code> block; catch any <code>Throwable</code> instances if (<em>when</em>?) something goes wrong; <code>close()</code> the resource if something goes wrong.
Add the <code>close()</code> call in a <code>finally</code> block for extra robustness.
All the while, handle the exceptions that might arise when you try to do anything, including calling <code>close()</code> the resource.
You&#8217;ll end up with one or more <code>try</code>/<code>catch</code> embedded within the outer <code>try</code>/<code>catch</code> blocks.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some examples.
I&#8217;ll read a file on the filesystem to demonstrate this new feature.
But something needs to ensure that there&#8217;s a file to read in the first place, so I&#8217;ve extracted all that out into a separate class, <code>Utils</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.closeable</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Utils</span> <span class="o">{</span>

    // <b class="conum">(1)</b>
    <span class="kd">static</span> <span class="nc">String</span> <span class="no">CONTENTS</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"""
            &lt;html&gt;
            &lt;body&gt;&lt;h1&gt; Hello, world, @ %s !&lt;/h1&gt; &lt;/body&gt;
            &lt;/html&gt;
            """</span><span class="o">,</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">toString</span><span class="o">()).</span><span class="na">trim</span><span class="o">();</span>

    // <b class="conum">(2)</b>
    <span class="kd">static</span> <span class="nc">File</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"bootiful"</span><span class="o">,</span> <span class="s">".txt"</span><span class="o">);</span>
            <span class="kt">var</span> <span class="n">file</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">toFile</span><span class="o">();</span>
            <span class="n">file</span><span class="o">.</span><span class="na">deleteOnExit</span><span class="o">();</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="no">CONTENTS</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">;</span>
        <span class="o">}</span><span class="c1">//</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"could not produce a new file"</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

    // <b class="conum">(3)</b>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">error</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>// <b class="conum">(2)</b>
        <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                <span class="s">"there's been an exception processing the read! "</span> <span class="o">+</span>
                <span class="n">throwable</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the contents of the file, using a handy multiline Java <code>String</code></p>
</li>
<li>
<p>this method returns the <code>java.io.File</code> for the newly created temporary file</p>
</li>
<li>
<p>a convenience method to log errors.
Do not rewrite this code!
Otherwise, if you&#8217;re doing things the old-fashioned way, you&#8217;ll find yourself rewriting this a <em>lot</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, let&#8217;s look at an example of what <em>not</em> to do.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.closeable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">bootiful</span><span class="o">.</span><span class="na">javareloaded</span><span class="o">.</span><span class="na">closeable</span><span class="o">.</span><span class="na">Utils</span><span class="o">.</span><span class="na">error</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">TraditionalResourceHandlingTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">setup</span><span class="o">();</span>// <b class="conum">(1)</b>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BufferedReader</span><span class="o">)</span> <span class="kc">null</span><span class="o">;</span> // <b class="conum">(2)</b>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">file</span><span class="o">));</span>
            <span class="kt">var</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="kt">var</span> <span class="n">line</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">lineSeparator</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="kt">var</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
            <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">contents</span><span class="o">,</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">CONTENTS</span><span class="o">);</span>
        <span class="o">}</span> <span class="c1">//</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> // <b class="conum">(3)</b>
            <span class="n">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="c1">//</span>
        <span class="k">finally</span> <span class="o">{</span> // <b class="conum">(4)</b>
            <span class="n">close</span><span class="o">(</span><span class="n">bufferedReader</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Reader</span> <span class="n">reader</span><span class="o">)</span> <span class="o">{</span> // <b class="conum">(3)</b>
        <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="c1">//</span>
            <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>from which file are we reading?</p>
</li>
<li>
<p>We need a reference to the <code>BufferedReader</code> outside of the scope of the <code>try</code>/<code>catch</code> block, but we don&#8217;t want to initialize that reference until we&#8217;re inside the <code>try</code>/<code>catch</code> block because it might incur an exception.</p>
</li>
<li>
<p>handle any errors.
Bear in mind that this solution doesn&#8217;t even attempt to field the errors and somehow recover.
If there is <em>any</em> error anywhere, then we abort.</p>
</li>
<li>
<p>also, make sure to close that <code>Reader</code>!
Err, close that reader <em>if</em> it&#8217;s not <code>null</code>!
Sorry, close that reader <em>if</em> it&#8217;s not <code>null</code> and also don&#8217;t forget to handle any errors in the doing, either!
Be kind, rewind!</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Yuck.
We can do better with Java 7&#8217;s <code>try-with-resources</code> construct.
Let&#8217;s rework the example accordingly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.closeable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">TryWithResourcesTest</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">setup</span><span class="o">();</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">tryWithResources</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">fileReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">file</span><span class="o">);</span><span class="c1">//</span>
			 <span class="kt">var</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">fileReader</span><span class="o">))</span> <span class="o">{</span>
			<span class="kt">var</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
			<span class="kt">var</span> <span class="n">line</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="kc">null</span><span class="o">;</span>
			<span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
				<span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">lineSeparator</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="kt">var</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
			<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">contents</span><span class="o">,</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">CONTENTS</span><span class="o">);</span>
		<span class="o">}</span> <span class="c1">//</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">Utils</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_inference">Type Inference</h3>
<div class="paragraph">
<p>Java 10 introduced type inference for variables given enough context.
As a result, Java is a strongly typed language with less typing - pressing of keys - required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.typeinference</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">TypeInferenceTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">infer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="kt">var</span> <span class="n">map1</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span> <span class="s">"value"</span><span class="o">);</span> // <b class="conum">(1)</b>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span> <span class="s">"value"</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">map2</span><span class="o">,</span> <span class="n">map1</span><span class="o">);</span> // <b class="conum">(1)</b>
		<span class="kt">var</span> <span class="n">anonymousSubclass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"Peanut the Poodle"</span><span class="o">;</span>

			<span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>

		<span class="o">};</span>
		// <b class="conum">(2)</b>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">anonymousSubclass</span><span class="o">.</span><span class="na">age</span><span class="o">,</span> <span class="mi">7</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">anonymousSubclass</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="s">"Peanut the Poodle"</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>both variable definitions contain a type of <code>Customer</code>.
The compiler knows it, and you know it because the right side of the expression makes it clear.
So, all things being equal, why not use the more concise version?</p>
</li>
<li>
<p>Indeed, in this case, the compiler knows <em>more</em> about the type than it would before, particularly in the case of anonymous subclasses.
Suppose you need a throwaway object in which to stash some data temporarily?
If you created an anonymous subclass of <code>Object</code> and assigned it to a variable of type <code>Object</code>, there&#8217;d be no way to dereference fields defined on the anonymous subclass.
Traditionally, there was no way to reify <em>anonymous</em> subclass types because they were <em>anonymous</em>.
But with <code>var</code>, you don&#8217;t need to account for the type; you can let the compiler infer it.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This last bit - reifying anonymous subclasses comes in particularly handy when you&#8217;re working with Java 8 streams abstractions and want to avoid having a host of throwaway classes created as side effects to conduct your data across the transformations.</p>
</div>
<div class="paragraph">
<p>The new <code>var</code> keyword can come in handy in a whole host of other smaller scenarios.
You can use the <code>var</code> keyword for parameters in a lambda definition.
It doesn&#8217;t buy you much over just omitting <code>var</code> (or the type itself), except that you can now decorate the parameter with annotations.
Neat!</p>
</div>
<div class="paragraph">
<p>Lambdas are the one fly in the proverbial ointment, however.
Java doesn&#8217;t have structural lambdas like Scala, Kotlin, and other languages.
Instead, you must assign the lambda to an instance of a functional interface like <code>java.util.function.Consumer&lt;T&gt;</code>.
If the literal lambda syntax doesn&#8217;t clarify what type that is, then the variable type definition itself must.
So you can use <code>var</code> for every variable definition <em>except</em> lambdas.
It&#8217;s so dissatisfying!
The agony of having a column of nice, clean `var&#8217;s punctuated occasionally with standard variable definitions just because those variables happen to be lambdas!
There is a way around it with casts, but I admit it isn&#8217;t much better.
Let&#8217;s look at some examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.typeinference</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">LambdasAndTypeInferenceTest</span> <span class="o">{</span>

	<span class="nd">@FunctionalInterface</span>
	<span class="kd">interface</span> <span class="nc">MyHandler</span> <span class="o">{</span>

		<span class="nc">String</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">String</span> <span class="n">one</span><span class="o">,</span> <span class="kt">int</span> <span class="n">two</span><span class="o">);</span>

	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">delegate</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">two</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Hello "</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">two</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">lambdas</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">MyHandler</span> <span class="n">defaultHandler</span> <span class="o">=</span> <span class="k">this</span><span class="o">::</span><span class="n">delegate</span><span class="o">;</span> // <b class="conum">(1)</b>
		<span class="kt">var</span> <span class="n">withVar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyHandler</span><span class="o">()</span> <span class="o">{</span> // <b class="conum">(2)</b>

			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="nc">String</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">String</span> <span class="n">one</span><span class="o">,</span> <span class="kt">int</span> <span class="n">two</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="nf">delegate</span><span class="o">(</span><span class="n">one</span><span class="o">,</span> <span class="n">two</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">};</span>
		<span class="kt">var</span> <span class="n">withCast</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyHandler</span><span class="o">)</span> <span class="k">this</span><span class="o">::</span><span class="n">delegate</span><span class="o">;</span> // <b class="conum">(3)</b>
		<span class="kt">var</span> <span class="n">string</span> <span class="o">=</span> <span class="s">"hello"</span><span class="o">;</span>
		<span class="kt">var</span> <span class="n">integer</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
		<span class="kt">var</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span> <span class="c1">//</span>
				<span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">withCast</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="n">integer</span><span class="o">),</span> <span class="c1">//</span>
						<span class="n">withVar</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="n">integer</span><span class="o">),</span> <span class="c1">//</span>
						<span class="n">defaultHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="n">integer</span><span class="o">)));</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">set</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="mi">1</span><span class="o">,</span> <span class="s">"the 3 entries should all be the same, and thus deduplicated out"</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>I can&#8217;t use <code>var</code> here because the compiler doesn&#8217;t know to which functional interface type the method reference, <code>delegate(String, Integer)</code>, should be assigned</p>
</li>
<li>
<p>I can use <code>var</code> here, but I&#8217;ve lost all the brevity of lambdas!</p>
</li>
<li>
<p>the only way I know around it is to cast the type like this.
Ugh.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I tend to use the cast form a lot.
Your sensibilities may vary, and given how new this feature is, I wouldn&#8217;t be surprised if my sensibilities change in the future with respect to this feature, as well.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enhanced_switch_expressions">Enhanced Switch Expressions</h3>
<div class="paragraph">
<p>Java has a new <em>enhanced</em> switch, which forms the basis of the gradual addition of <em>pattern amtching</em> to the Java language.
It simplifies things considerably:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.switches</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">TraditionalSwitchExpressionTest</span> <span class="o">{</span>

	<span class="kd">enum</span> <span class="nc">Emotion</span> <span class="o">{</span>

		// <b class="conum">(1)</b>
		<span class="no">HAPPY</span><span class="o">,</span> <span class="no">SAD</span>

	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">switchExpression</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span><span class="o">.</span><span class="na">HAPPY</span><span class="o">),</span> <span class="s">"that's wonderful."</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span><span class="o">.</span><span class="na">SAD</span><span class="o">),</span> <span class="s">"I'm so sorry to hear that."</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span> <span class="n">emotion</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">var</span> <span class="n">response</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span> // <b class="conum">(2)</b>
		<span class="k">switch</span> <span class="o">(</span><span class="n">emotion</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">case</span> <span class="nl">HAPPY:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="s">"that's wonderful."</span><span class="o">;</span>
			<span class="k">break</span><span class="o">;</span> // <b class="conum">(3)</b>
		<span class="k">case</span> <span class="nl">SAD:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="s">"I'm so sorry to hear that."</span><span class="o">;</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">response</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>Emotion</code> is an <code>enum</code>.
There are only two possible values (for this simple example that doesn&#8217;t at all reflect the rich gradient of human emotions) for a variable of type <code>Emotion</code>: <code>HAPPY</code> and <code>SAD</code>.
We have branches for all known states in this' switch' statement.
The compiler is satisfied that we have covered every possible value, so it doesn&#8217;t insist on a <code>default</code> branch to handle any unforeseen values.
There are no unforeseen values.
We say that we&#8217;ve <em>exhausted</em> the range of values.</p>
</li>
<li>
<p>we define a variable to which we assign the results of our processing.</p>
</li>
<li>
<p>take care to <code>break</code> for each branch.
Otherwise, the execution flow will drop down to other branches, producing undesirable side effects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first example is a classic <code>switch</code> statement.
There&#8217;s nothing wrong, <em>per se</em>, but it&#8217;s tedious, and I tend to avoid writing them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.switches</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">EnhancedSwitchExpressionTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">switchExpression</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span><span class="o">.</span><span class="na">HAPPY</span><span class="o">),</span> <span class="s">"that's wonderful."</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span><span class="o">.</span><span class="na">SAD</span><span class="o">),</span> <span class="s">"I'm so sorry to hear that."</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">respondToEmotionalState</span><span class="o">(</span><span class="nc">Emotion</span> <span class="n">emotion</span><span class="o">)</span> <span class="o">{</span> // <b class="conum">(1)</b>
		<span class="k">return</span> <span class="nf">switch</span> <span class="o">(</span><span class="n">emotion</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">case</span> <span class="no">HAPPY</span> <span class="o">-&gt;</span> <span class="s">"that's wonderful."</span><span class="o">;</span>
		<span class="k">case</span> <span class="no">SAD</span> <span class="o">-&gt;</span> <span class="s">"I'm so sorry to hear that."</span><span class="o">;</span>
		<span class="o">};</span>
	<span class="o">}</span>

	<span class="kd">enum</span> <span class="nc">Emotion</span> <span class="o">{</span>

		<span class="no">HAPPY</span><span class="o">,</span> <span class="no">SAD</span><span class="o">;</span>

	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>there&#8217;s no intermediate variable!
Each branch produces a value, and that value is the result of the <code>switch</code> expression and can be assigned to a variable or, as I do here, returned in one fell swoop from the method as any other expression would.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_multiline_strings">Multiline Strings</h3>
<div class="paragraph">
<p>This one is a super small feature that punches well above its weight: Java supports multiline `String`s: hooray!
There are a million opportunities for multiline `String`s: SQL queries, HTML, Markdown, Asciidoctor, Velocity templating (such as for emails), unit testing, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">MultilineStringsTest</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">instant</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

	// <b class="conum">(1)</b>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">multilines</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"""
			&lt;html&gt;
			&lt;body&gt;
			&lt;h1&gt; Hello, world, @ %s!&lt;/h1&gt; &lt;/body&gt;
			&lt;/html&gt;
			"""</span><span class="o">,</span> <span class="n">instant</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>

	// <b class="conum">(2)</b>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">concatenated</span> <span class="o">=</span> <span class="s">"&lt;html&gt;\n&lt;body&gt;\n"</span> <span class="o">+</span> <span class="s">"&lt;h1&gt; Hello, world, @ "</span> <span class="o">+</span> <span class="n">instant</span> <span class="o">+</span> <span class="s">"!&lt;/h1&gt; &lt;/body&gt;\n"</span>
			<span class="o">+</span> <span class="s">"&lt;/html&gt;"</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">stringTheory</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">multilines</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">concatenated</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The first example uses a multiline <code>String</code> to represent some HTML markup</p>
</li>
<li>
<p>The second variable recreates the same HTML markup, down to the padding and the newlines, but uses string concatenation and manually encodes newlines, as we used to have to do.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the example, both variables <code>multilines</code>, and <code>concatenated</code>, are identical, but I the multiline <code>String</code> is much easier to wrangle.</p>
</div>
<div class="paragraph">
<p>Short and simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_records">Records</h3>
<div class="paragraph">
<p>Records are perhaps my second favorite new feature in Java.
If you&#8217;ve ever used case classes in Scala, or data classes in Kotlin, you&#8217;ll feel <em>almost</em> right at home.</p>
</div>
<div class="paragraph">
<p>Java introduced records, which are a new kind of type.
Records, like enums, are a restricted form of a class.
As a result, they&#8217;re ideal for "plain data carriers," classes containing data not meant to be altered and only the most fundamental methods such as constructors and accessors.
We&#8217;ll use (and sometimes abuse) them <em>all</em> the time in this book.
They&#8217;re wonderful time savers.
Need to model a read-only entity in your database that has accessors for all the constituent fields, a constructor, a functional <code>toString</code> implementation, a valid <code>equals</code> implementation, and a valid <code>hashCode</code> implementation?
You&#8217;d better get codin'!
That&#8217;ll take a while.
Or, you could use something like Lombok to code-generate all of that for you based on the presence of a handful of annotations.
Or, you could use records.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a trivial example.
Suppose you want to return information about <code>Customer</code> entities <em>and</em> their associated <code>Order</code> data.
Unfortunately, Java doesn&#8217;t support multiple return types or provide suitable tuple types, so you need to create something to hold both types.
Records to the rescue!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.records</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>


<span class="kd">class</span> <span class="nc">SimpleRecordsTest</span> <span class="o">{</span>

	// <b class="conum">(1)</b>
	<span class="n">record</span> <span class="nf">Customer</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="n">record</span> <span class="nf">Order</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="kt">double</span> <span class="n">total</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="n">record</span> <span class="nf">CustomerOrders</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">records</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">var</span> <span class="n">customer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Customer</span><span class="o">(</span><span class="mi">253</span><span class="o">,</span> <span class="s">"Tammie"</span><span class="o">);</span>
		<span class="kt">var</span> <span class="n">order1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">(</span><span class="mi">2232</span><span class="o">,</span> <span class="mf">74.023</span><span class="o">);</span>
		<span class="kt">var</span> <span class="n">order2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">(</span><span class="mi">9593</span><span class="o">,</span> <span class="mf">23.44</span><span class="o">);</span>
		<span class="kt">var</span> <span class="n">cos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomerOrders</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">order1</span><span class="o">,</span> <span class="n">order2</span><span class="o">));</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">order1</span><span class="o">.</span><span class="na">id</span><span class="o">(),</span> <span class="mi">2232</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">order1</span><span class="o">.</span><span class="na">total</span><span class="o">(),</span> <span class="mf">74.023</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">customer</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="s">"Tammie"</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">cos</span><span class="o">.</span><span class="na">orders</span><span class="o">().</span><span class="na">size</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"order components  "</span> <span class="o">+</span>  <span class="n">order1</span><span class="o">.</span><span class="na">id</span><span class="o">()</span> <span class="o">+</span> <span class="sc">':'</span> <span class="o">+</span> <span class="n">order1</span><span class="o">.</span><span class="na">total</span><span class="o">());</span> // <b class="conum">(2)</b>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>these three <code>record</code> definitions define three new types, each with accessors, constructors, and internal storage.
Scarcely more than three lines of code for three brand new types!</p>
</li>
<li>
<p>records also automatically expose accessor methods for the fields defined in the constructor.
For example, if you want to read the <code>name</code> field of the <code>Customer</code> type, use <code>Customer#name()</code>.
If you wish to read the <code>orders</code> field of the <code>CustomerOrders</code> type, use <code>orders()</code>.
It took a while to accept that they they&#8217;re in the form <code>x()</code>, and not in the form <code>getX()</code>, but I&#8217;ve come to love it.
Mercifully, all the interesting libraries that need to know about this convention - JSON serializers, for example - already work well with it.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Records make perfect sense for immutable, data-centric types.
They alleviate a whole host of boilerplate code.
In the first edition of this book, I used the <a href="https://projectlombok.org">Lombok project</a> (which is brilliant) to synthesize the getters, setters, no-args, and all-arg constructors with just a few annotations.
It worked, but it was still a handful of lines instead of the one-liners enabled by Java records.
I love records!</p>
</div>
<div class="paragraph">
<p>I still occasionally use Lombok for other things, but it&#8217;s nice to reduce my reliance on it further.</p>
</div>
<div class="paragraph">
<p>More controversially, I also sometimes use records to implement services and components quickly.
After all, you can have methods on a record.
Of course, record implementations can&#8217;t extend classes, but one doesn&#8217;t need to do that a lot.
There is the undesirable side-effect of having accessor-methods that expose the state - <code>dataSource()</code> or whatever - but, for whatever reason, I don&#8217;t care.
It doesn&#8217;t cost me anything when I use it.
If my code grows large enough to need hierarchies or interface implementations, I&#8217;ll change it.
If the code grows enough to worry about the leaking state, I&#8217;ll change it.
But the immediate, short-term effect of having more concise, approachable, readable code seems to make sense to me.
Maybe one day that&#8217;ll change?</p>
</div>
<div class="paragraph">
<p>Behind the scenes, a record creates a default constructor whose parameters match the types and rarity of the record header.
Records can have other constructors, but they need to delegate to the default constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded.records</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StringUtils</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">RecordConstructorsTest</span> <span class="o">{</span>

	<span class="n">record</span> <span class="nf">Customer</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span> // <b class="conum">(1)</b>

		<span class="nc">Customer</span> <span class="o">{</span> // <b class="conum">(2)</b>
			<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"the id must never be null!"</span><span class="o">);</span>
			<span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">email</span><span class="o">),</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"the email is invalid"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nc">Customer</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">multipleConstructors</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">var</span> <span class="n">customer1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Customer</span><span class="o">(</span><span class="s">"test@email.com"</span><span class="o">);</span>
		<span class="kt">var</span> <span class="n">customer2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Customer</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"test2@gmail.com"</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">customer1</span><span class="o">.</span><span class="na">id</span><span class="o">(),</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">customer2</span><span class="o">.</span><span class="na">id</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the default constructor is the one defined in the record header</p>
</li>
<li>
<p>If you want to act on the fields passed in the default constructor, create a constructor with no parameters and do the work there.
This no-parameter constructor and the record header taken together are the default constructor.
If you want to have an alternative constructor, you can do that so long as you forward to the default constructor.
I use the default constructor to initialize the <code>id</code> to <code>-1</code>.
This way, it&#8217;s impossible to initialize the record with a <code>null</code> <code>id</code> field.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_sealed_types">Sealed Types</h3>
<div class="paragraph">
<p>Sealed types are a novel feature that hasn&#8217;t reached its full potential yet.
The basic idea is to constrain the number of subtypes for a given type.
Why would you do this?
Well, it&#8217;s all a bit <em>exhausting</em>!
Or should I say, it&#8217;s all about exhausting the extent to which the runtime needs to support virtual (polymorphic) dispatch?</p>
</div>
<div class="paragraph">
<p>Sound complicated?
It&#8217;s not really.
Ever have a method in a parent type that the child type overrides?
The ability to call that method on an instance of that child type, in terms of the parent type&#8217;s interface, is called polymorphism.</p>
</div>
<div class="paragraph">
<p>Polymorphic, or <em>virtual</em>, dispatch requires a lookup in the virtual function table, which in theory takes time.
The runtime wouldn&#8217;t have to do that if it could say conclusively that a given type can never be subclassed, such as with a final type.
The <code>final</code> keyword is a bit of a sledgehammer, however.
It forecloses entirely on the possibility of on any kind whatsoever subclassing the final type.
You might have a hierarchy but wish to keep it shallow, and well-known.
Alternatively, you could make everything package-private (simply omit <code>public</code> modifier on the class), which means that only types in the same class could subclass the type.
This would probably work, but of course, somebody else could come along and create types in the same package in their <code>.jar</code>.
There&#8217;s traditionally not been a lot of great ways to keep a hierarchy shallow until now.
Sealed types can help.
They let you constrain the number of subclasses to a known set.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at an example that is building out a</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">SealedTypesTest</span> <span class="o">{</span>

	// <b class="conum">(1)</b>
	<span class="n">sealed</span> <span class="kd">interface</span> <span class="nc">Shape</span> <span class="n">permits</span> <span class="nc">Oval</span><span class="o">,</span> <span class="nc">Polygon</span> <span class="o">{</span>

	<span class="o">}</span>

	// <b class="conum">(2)</b>
	<span class="kd">static</span> <span class="n">sealed</span> <span class="kd">class</span> <span class="nc">Oval</span> <span class="kd">implements</span> <span class="nc">Shape</span> <span class="n">permits</span> <span class="nc">Circle</span> <span class="o">{</span>

	<span class="o">}</span>

	<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Circle</span> <span class="kd">extends</span> <span class="nc">Oval</span> <span class="o">{</span>

	<span class="o">}</span>

	<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Polygon</span> <span class="kd">implements</span> <span class="nc">Shape</span> <span class="o">{</span>

	<span class="o">}</span>

	// <b class="conum">(3)</b>
	<span class="c1">// static final class Rhombus implements Shape {}</span>

	// <b class="conum">(4)</b>
	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">describeShape</span><span class="o">(</span><span class="nc">Shape</span> <span class="n">shape</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">shape</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"the shape should never be null!"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">shape</span> <span class="k">instanceof</span> <span class="nc">Oval</span><span class="o">)</span>
			<span class="k">return</span> <span class="s">"round"</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">shape</span> <span class="k">instanceof</span> <span class="nc">Polygon</span><span class="o">)</span>
			<span class="k">return</span> <span class="s">"straight"</span><span class="o">;</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"we should never get to this point!"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">disjointedUnionTypes</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">describeShape</span><span class="o">(</span><span class="k">new</span> <span class="nc">Oval</span><span class="o">()),</span> <span class="s">"round"</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">describeShape</span><span class="o">(</span><span class="k">new</span> <span class="nc">Polygon</span><span class="o">()),</span> <span class="s">"straight"</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>we&#8217;ll start with a <code>Shape</code> and permit two direct subclasses, <code>Oval</code> and <code>Polygon</code>.</p>
</li>
<li>
<p>a subclass of a sealed type must be <code>final</code> or <code>sealed</code> and explicitly name its subclasses.
A sealed type&#8217;s subclasses may themselves be sealed types, permitting further subtypes.</p>
</li>
<li>
<p>the following declaration does not compile, as it is not one of the explicitly permitted subclasses</p>
</li>
<li>
<p>the <code>describeShape</code> method is written so that we can exhaustively handle every subclass.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sealed types help the compiler, too.
The compiler can exhaustively determine every case of every possible subtype, which has implications for the future, as Java looks to better incorporate simple pattern matching into Java.
Imagine the possibilities here, and you can kind of see how sealed types might play with the new <code>switch</code> expressions, too.</p>
</div>
<div class="paragraph">
<p>Right now, I don&#8217;t recommend using <code>sealed</code> types.
I tend to think types should be open by default.
You just don&#8217;t know what scenario will arise in the future that changes your fundamental assumptions.
Furthermore, sealed subtypes are <code>final</code>, inhibiting tools like Spring and Hibernate, which must subclass your types to proxy them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_smart_casts">Smart Casts</h3>
<div class="paragraph">
<p>This feature is one of those things that I don&#8217;t use all that often in application code, but it&#8217;s pretty useful when writing infrastructure code when dealing with polymorphism.
Essentially, the feature spares you from having to create an intermediate variable and casting after you&#8217;ve already done an <code>instanceof</code> check.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmartCastsTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">casts</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">interface</span> <span class="nc">Animal</span> <span class="o">{</span>

            <span class="nc">String</span> <span class="nf">speak</span><span class="o">();</span>

        <span class="o">}</span>

        <span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">implements</span> <span class="nc">Animal</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">speak</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"meow!"</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span>

        <span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">implements</span> <span class="nc">Animal</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">speak</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"woof!"</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span>

        <span class="kt">var</span> <span class="n">newPet</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">5</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">Cat</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Dog</span><span class="o">();</span>
        <span class="kt">var</span> <span class="n">messages</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>

        // <b class="conum">(1)</b>
        <span class="k">if</span> <span class="o">(</span><span class="n">newPet</span> <span class="k">instanceof</span> <span class="nc">Cat</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">var</span> <span class="n">cat</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Cat</span><span class="o">)</span> <span class="n">newPet</span><span class="o">;</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"the cat says "</span> <span class="o">+</span> <span class="n">cat</span><span class="o">.</span><span class="na">speak</span><span class="o">());</span>
        <span class="o">}</span>
        // <b class="conum">(2)</b>
        <span class="k">if</span> <span class="o">(</span><span class="n">newPet</span> <span class="k">instanceof</span> <span class="nc">Cat</span> <span class="n">cat</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"the cat says "</span> <span class="o">+</span> <span class="n">cat</span><span class="o">.</span><span class="na">speak</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">newPet</span> <span class="k">instanceof</span> <span class="nc">Dog</span> <span class="n">dog</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"the dog says "</span> <span class="o">+</span> <span class="n">dog</span><span class="o">.</span><span class="na">speak</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">messages</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"the dog says woof!"</span><span class="o">)</span> <span class="o">||</span> <span class="n">messages</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"the cat says meow!"</span><span class="o">));</span>

    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>this is a classic example, where we determine the subtype and then create a variable cast to the appropriate type.
If ever we change the type definition, we have to replace it both in the cast and in the <code>instanceof</code> check.</p>
</li>
<li>
<p>the more excellent, newer alternative uses a smart-cast, sparing us the extra variable and cast.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This feature looks almost exactly like a similar feature in Kotlin, and I love it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_function_interfaces_lambdas_and_method_references">Function Interfaces, Lambdas  and Method References</h3>
<div class="paragraph">
<p>Java 8 introduced lambdas.
They let us treat functions as first-class citizens that can be assigned and passed around.
Well, almost.
In Java, lambdas are slightly limited; they&#8217;re <em>not</em> first-class citizens.
But, close enough!
They <em>must</em> have return values and input parameters compatible with the method signature of the sole abstract method of an interface.
This interface, one with a single abstract method intended for use as a lambda, is called a <em>functional interface</em>.
(Interfaces may also have <em>default</em>, non-abstract methods where the interface provides an implementation.)</p>
</div>
<div class="paragraph">
<p>There are some very convenient and oft-used functional interfaces in the JDK itself.
Here are some of my favorites.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.function.Function&lt;I, O&gt;</code>: an instance of this interface accepts a type <code>I</code> and returns a type ` O'.
This is useful as a general-purpose function.
Every other function could, in theory, be generalized from this.
Thankfully, there&#8217;s no need for that as several other handy functional interfaces exist.</p>
</li>
<li>
<p><code>java.util.function.Predicate&lt;T&gt;</code>: an instance of this interface accepts a type <code>T</code> and returns a <code>boolean</code>.
This is an ideal filter when you&#8217;re trying to sift through a stream of values.</p>
</li>
<li>
<p><code>java.util.function.Supplier&lt;T&gt;</code>: A supplier accepts no input and returns an output.</p>
</li>
<li>
<p><code>java.util.function.Consumer&lt;T&gt;</code>: A consumer is the mirror image of a <code>Supplier&lt;T&gt;</code>; it takes an input and returns no output.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also create and use your custom functional interfaces.
Let&#8217;s look at some examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">bootiful.javareloaded</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">LambdasTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kt">void</span> <span class="nf">lambdas</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">stringIntegerFunction</span> <span class="o">=</span> <span class="n">str</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">;</span>// <b class="conum">(1)</b>
		<span class="kd">interface</span> <span class="nc">MyHandler</span> <span class="o">{</span>

			<span class="nc">String</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">String</span> <span class="n">one</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">two</span><span class="o">);</span>

		<span class="o">}</span>
		<span class="nc">MyHandler</span> <span class="n">withExplicit</span> <span class="o">=</span> <span class="o">(</span><span class="n">one</span><span class="o">,</span> <span class="n">two</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="o">+</span> <span class="sc">':'</span> <span class="o">+</span> <span class="n">two</span><span class="o">;</span>// <b class="conum">(2)</b>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">stringIntegerFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="s">""</span><span class="o">),</span> <span class="mi">2</span><span class="o">);</span>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">withExplicit</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="s">"one"</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="s">"one:2"</span><span class="o">);</span>
		<span class="kt">var</span> <span class="n">withVar</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyHandler</span><span class="o">)</span> <span class="o">(</span><span class="n">one</span><span class="o">,</span> <span class="n">two</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">one</span> <span class="o">+</span> <span class="sc">':'</span> <span class="o">+</span> <span class="n">two</span><span class="o">;</span>// <b class="conum">(3)</b>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">withVar</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="s">"one"</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="s">"one:2"</span><span class="o">);</span>
		<span class="nc">MyHandler</span> <span class="n">delegate</span> <span class="o">=</span> <span class="k">this</span><span class="o">::</span><span class="n">doHandle</span><span class="o">;</span> // <b class="conum">(4)</b>
		<span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="s">"one"</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="s">"one:2"</span><span class="o">);</span>

	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">doHandle</span><span class="o">(</span><span class="nc">String</span> <span class="n">one</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">two</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">one</span> <span class="o">+</span> <span class="sc">':'</span> <span class="o">+</span> <span class="n">two</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>You can use existing functional interfaces in the JDK&#8230;&#8203;</p>
</li>
<li>
<p>you can define your own interfaces and use them as functional interfaces</p>
</li>
<li>
<p>You may use <code>var</code> and lambdas together with this (admittedly unsightly) cast.</p>
</li>
<li>
<p>and if you have existing methods whose return types and input parameters line up with the single abstract method of a functional interface, then you can create a method reference and assign it to an instance of that type.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_virtual_threads_and_loom">Virtual Threads and Loom</h3>
<div class="paragraph">
<p>I wrote a book called <em>Reactive Spring</em>, which embraces the promise of reactive programming on the JVM in terms of the vast Spring ecosystem support around it. I love that book. It taught me about three incredible opportunities in reactive programming.</p>
</div>
<div class="sect3">
<h4 id="_scalable_input_and_output_io">Scalable Input and Output (IO)</h4>
<div class="paragraph">
<p>Reactive programming introduces a functional programming model that gives a reactive runtime more fine grained opportunities to move work on and off threads. Threads on the JVM, prior to Java 21, have been expensive to create. They take up a good deal in RAM - about two megabytes per thread, making it prohibitive to create many of them.  Prior to Java 21, traditional input and output (using <code>java.io.InputStream</code> and <code>java.io.OutputStream</code>) was said to be <em>blocking</em>. Suppose you have a Java thread in which you&#8217;re reading data from a network client. You call <code>InputStream#read()</code>, but can&#8217;t be sure it will return in time.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>composition</strong>:</p>
</li>
<li>
<p><strong>robustness</strong>:</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_next_steps">Next Steps</h3>
<div class="paragraph">
<p>I didn&#8217;t intend for this chapter to be a thorough introduction to all things Java.
Just an amuse-bouche for all the cool stuff you might see me do in my code independent of Spring.
Java 17 is a very compelling way to write code, and it&#8217;s no coincidence that it&#8217;s starting to look more and more like languages like Kotlin, which is also a lovely way to write Spring Boot-based applications.
Hopefully, this chapter has been persuasive, and you&#8217;re ready to turn the page.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>