<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        Spring CRM
    </title>
    <style>
        html {
            line-height: 1.5em;
        }
    </style>
</head>
<body>


<script>

    const root = '/api';

    async function getCustomers() {
        const response = await fetch(root + '/customers')
        return await response.json()
    }

    async function getMeEndpoint() {
        const response = await fetch(root + '/me')
        return await response.json()
    }

    async function postEmail(customerId) {
        try {
            const response = await fetch(root + '/email?customerId=' + customerId, {method: 'POST'})
            const data =  await response.json()
            console.log(data)
            return data
        }//
        catch (e) {
            console.log(e.toString())
        }
    }

    window.addEventListener('load', async (event) => {
        document.getElementById('me').innerHTML = (await getMeEndpoint()).name;
        const customersDiv = document.getElementById('customers')
        const customers = await getCustomers()
        customers.forEach(customer => {
            const div = document.createElement('div')
            const customerId = customer.id
            const customerName = customer.name
            const divId = 'c' + customerId
            div.innerHTML = `
              <button type="button">send email</button>
              <span style = "font-weight: bold"> ${customerId} </span>
              <span> ${customerName}</span>
            `
            div.id = divId
            customersDiv.appendChild(div)
            document
                .querySelector('#' + divId)
                .addEventListener('click', () => postEmail(customerId))
        });
    })
</script>

<div>welcome, <span style="font-weight: bold" id="me"></span></div>
<div id="customers"></div>


</body>
</html>